---
title: "Biostatistiques"
author: "Serge-√âtienne Parent"
date: "09 f√©vrier 2019"
#output: pdf_document
output:
  revealjs::revealjs_presentation:
    theme: night
    highlight: kate
    transition: slide
    center: true
    css: custom.css
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
library("tidyverse")
library("nlme")
library("ggthemr")
ggthemr('dust')

library("agridat")
data("lasrosas.corn")

set.seed(8946)
espece <- c("Leptinosith darthvador", "Delia leia", "Pieris jaba")
n <- 20
dv <- tibble(espece = rep(espece[1], n), dommage = rnorm(n, 10, 5))
pl <- tibble(espece = rep(espece[2], n), dommage = rnorm(n, 7, 3))
jh <- tibble(espece = rep(espece[3], n), dommage = rnorm(n, 5, 3))
all <- bind_rows(dv, pl, jh)
write_csv(all, "data/bibittes.csv")

statut <- c("Totalement en d√©saccord", 
            "En d√©saccord",
            "Ni en accord, ni en d√©saccord",
            "En accord",
            "Totalement en accord")
statut_o <- factor(statut, levels = statut, ordered=TRUE)
```

## Objectifs sp√©cifiques (1/2)

√Ä la fin de ce chapitre, vous

- serez en mesure de d√©finir les concpets de base en statistique: population, √©chantillon, variable, probabilit√© et distribution
- serez en mesure de calculer des statistiques descriptives de base: moyenne et √©cart-type, quartiles, maximum et minimum
- comprendrez les notions de test d‚Äôhypoth√®se, d‚Äôeffet et de p-value, ainsi qu‚Äô√©viter les erreurs communes dans leur interpr√©tation

## Objectifs sp√©cifiques (2/2)

- saurez effectuer une mod√©lisation statistique lin√©aire simple, multiple et mixte, entre autre sur des cat√©gories
- saurez effectuer une mod√©lisation statistique non lin√©aire simple, multiple et mixte

## Tout commence par une question

Que voulez-vous exprimer?

![](images/Screenshot_2019-02-06 HEATHER KRAUSE - OpenVis Conf 2018 - YouTube.png)

[Source](https://www.youtube.com/watch?v=uw1Tag08dK4&feature=youtu.be)

## La question

Que voulez-vous exprimer?

![](images/Screenshot_2019-02-06 HEATHER KRAUSE - OpenVis Conf 2018 - YouTube(1).png)

[Source](https://www.youtube.com/watch?v=uw1Tag08dK4&feature=youtu.be)

## O√π renforcer l'avion?

Disposition des trous de balle sur les avions britaniques de retour de leur sortie durant la deuxi√®me guerre mondiale.

![](images/IMG_20190206_154711.jpg)
Source: Whitlock et Schuluter (2015), [The Analysis of Biological Data](http://whitlockschluter.zoology.ubc.ca/).

## D√©finitions

> La statistique est l‚Äô√©tude des m√©thodes pour mesurer des aspects de populations √† partir d‚Äô√©chantillons et pour quantifier l'incertitude des mesures. (ma traduction de [Whitlock et Schuluter (2015)](http://whitlockschluter.zoology.ubc.ca/)).

## Population

Ensemble circonscrit du sujet d'√©tude.

## √âchantillon

Sous-ensemble de la population.

Si l'√©chantillon est repr√©sentatif de la population (non biais√©), on peut extrapoler ses propri√©t√©s √† la population (inf√©rence).

## Variable al√©atoire

Dimension d'un objet catract√©ris√© par une distribution de probabilit√©.

## Probabilit√©

Une probabilit√© est la vraisemblance qu'un √©v√®nements se r√©alise chez un √©chantillon. 

## Distribution de probabilit√©

Une distribution d√©crit la probabilit√© d'obtenir une valeur (distribution discr√®te) ou une plage de valeurs (distribution continue) dans une √©chantillon pris au hasard d'une population.

Une distribution des probabilit√© est d√©crite par un ou plusieurs **param√®tres**, par exemple une moyenne et un √©cart-type dans le cas d'une distribution normale.

## **Une** statistique

Une **statistique** est une estimation d'un param√®tre calcul√©e √† partir des donn√©es, par exemple une moyenne et un √©cart-type √©chantillonnaux.

## Statistiques fr√©quentielles ou bay√©siennes

**Fr√©quentielle**. Les donn√©es sont g√©n√©r√©es par des m√©canismes stochastiques d√©crits par des distributions de probabilit√©s, et nous cherchons √† d√©terminer la probabilit√© que les donn√©es soient g√©n√©r√©es par ces m√©canismes (p-valule). <-- approche la plus commune (et couverte dan ce chapitre)

## Statistiques fr√©quentielles ou bay√©siennes

**Bay√©sienne**. Les param√®tres et leur incertitude sont d√©termin√©s par les donn√©es et les connaissances pr√©alables. <-- approche de plus en plus utilis√©e (effleur√©e dans le chapitre 6, en extra)

## Bayes ou freq?

Tout d√©pend de la question pos√©e. 

- **Bay√©sien**: quelle est la probabilit√© qu'il y ait de la vie sur Mars?
- **Fr√©quentiel**: est-ce que les donn√©es sont conformes avec avec l'hypoth√®se de la vie sur Mars 

<small>exemple tir√©e du blogue [Dynamic Ecology](https://dynamicecology.wordpress.com/2011/10/11/frequentist-vs-bayesian-statistics-resources-to-help-you-choose/)</small>

## Plusieurs types de distribution

##

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
x <- 0:25
y <- dbinom(x = x, size = 25, prob = 0.5)
ggplot(data = tibble(x, y), mapping = aes(x, y)) +
  geom_segment(aes(x = x, xend = x, y = 0, yend = y), color = "grey50") +
  geom_point() +
  labs(title = "Binomiale",
       subtitle = "Nombre d'√©v√©nements vrais obtenus apr√®s n tirages. Exemples: pr√©sence/absence.",
       y = "Fr√©quence")
```

## 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
x <- 1:30
y <- dpois(x, lambda = 8)
ggplot(data = tibble(x, y), mapping = aes(x, y)) +
  geom_segment(aes(x = x, xend = x, y = 0, yend = y), color = "grey50") +
  geom_point() +
  labs(title = "Poisson",
       subtitle = "Nombre d‚Äô√©v√®nements se produisant dans l'espace ou dans le temps. Exemples: d√©comptes.",
       y = "Fr√©quence")
```

##

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
increment <- 0.01
x <- seq(-10, 10, by = increment)
y1 <- dnorm(x, mean = 0, sd = 1)
y2 <- dnorm(x, mean = 0, sd = 2)
y3 <- dnorm(x, mean = 0, sd = 3)
gg_norm <- tibble(x, `sd = 1` = y1, `sd = 2` = y2, `sd = 3` = y3) %>% gather(variable, value, -x)

ggplot(data = gg_norm, mapping = aes(x = x, y = value)) +
  geom_line(aes(colour = variable)) +
  labs(title = "Normale",
       subtitle = "L'aire sous la courbe entre deux valeurs d√©signe la probabilit√© d'obtention\nd'une valeur continue sur une certaine plage.",
       y = "Fr√©quence")

```

## Les tests d'hypoth√®se

Un test d'hypoth√®se permet de d√©cider si une hypoth√®se est confirm√©e ou rejet√©e √† un seuil de probabilit√© pr√©d√©termin√©.

**H0**. L'hypoth√®se nulle propose l'absence d'effet statistique (c'est l'hypoth√®se de l'avocat du diable üòà) .

**H1**. L'hypoth√®se alternative propose l'inverse (üòá).

## Exemple

Est-ce que les donn√©es sont conforment avec avec l'hypoth√®se de la vie sur Mars.

**H0**. Il n'y a pas de vie sur Mars.

**H1**. Il y a de la vie sur Mars.

## 

> **Dans une exp√©rience, la confirmation de l'hypoth√®se nulle n'est pas un √©chec.**

## Test de t (Student) √† deux √©chantillons

Comparaison des moyennes deux √©chantillons dont la distribution est normale et dont la variance est la m√™me.

```{r, fig.height = 4, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
set.seed(562354)

n <- 30
a <- rnorm(n, 10, 3)
b <- rnorm(n, 8, 2)

exemple_ech <- tibble(a, b) %>% gather(echantillon, value)

ggplot(data = exemple_ech, mapping = aes(x = value)) +
  geom_histogram(mapping = aes(fill = echantillon), color = "grey35", bins = 10)

```

##

```{r}
exemple_ech %>% sample_n(5)
tt_exemple <- t.test(formula = value ~ echantillon,
                     data = exemple_ech, var.equal = TRUE)
tt_exemple
```

## Enregistrer les r√©sultats dans un objet

```{r}
str(tt_exemple)
tt_exemple$p.value
```

## p-value (1/)

> "La p-value n'a jamais √©t√© con√ßue comme substitut au raisonnement scientifique" [Ron Wasserstein, directeur de l'American Statistical Association](https://phys.org/news/2016-03-american-statistical-association-statement-significance.html) [ma traduction]. 

## p-value (2/)

**Un r√©sultat montrant une p-value plus √©lev√©e que 0.05 est-il pertinent?**

Lors d'une conf√©rence, Dr Evil ne pr√©sentent que les r√©sultats significatifs de ses essais au seuil de 0.05. Certains essais ne sont pas significatifs, mais bon, ceux-ci ne sont pas importants...

![](images/ezgif-4-7900b0e67dff.gif)


## Rappel

> **Dans une exp√©rience, la confirmation de l'hypoth√®se nulle n'est pas un √©chec.**

## p-value: erreurs (3/)

1. Pour √©valuer l'importance de l'effet: voir le coefficient. Pour √©valuer son incertitude: voir son intervalle de confiance.
2. Il est tout aussi important de savoir que le traitement fonctionne que de savoir qu'il ne fonctionne pas.
3. Le seuil de 0.05 est arbitraire.

## p-value: p-hacking ou data dregging (4/)

Modifier les donn√©es ou la question pos√©e dans le but d'obtenir une p-value < 0.05, c'est tricher.

## L'analyse de variance (ANOVA)

Comparaison des **moyennes** de plus de 2 groupes (√† variance √©gale)

```{r}
pl_aov <- aov(Petal.Length ~ Species, iris)
summary(pl_aov)
```

## Mod√©lisation statistique

$$Y = f\left( X \right)$$
$X$: variables pr√©dictives / ind√©pendantes / covariables / explicatives
$Y$: variables de sortie / r√©ponse / d√©pendante

## Mod√®les pr√©dictifs / explicatifs

----
<font size="8">‚ö†Ô∏è Ne pas confondre. ‚ö†</font>
----

Mod√®les **pr√©dictifs**. Le mod√®le doit √™tre test√© sur des donn√©es qui n'ont pas servi √† l'entra√Æner. (chapitre 12)

Mod√®le **explicatif**. Le mod√®le sert √† tester des hypoth√®ses. (chapitres 5)

## Variables fixes et al√©atoires

**Variables fixes**: test√©es lors de l‚Äôexp√©rience: dose du traitement, esp√®ce/cultivar, m√©t√©o, etc.

**Variables al√©atoires**: sources de variation qui g√©n√®rent du bruit dans le mod√®le: les unit√©s exp√©rimentales ou le temps lors de mesures r√©p√©t√©es.

## Mod√®le lin√©aire univari√©

$$y = \beta_0 + \beta_1 x + \epsilon$$

## Mod√®le lin√©aire univari√©

**Question**. Le rendement varie-t-il selon la dose d'azote?

**H0**. la dose d'azote n'affecte pas le rendement ($\beta_1 = 0$).

```{r, fig.height=4, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
ggplot(data = lasrosas.corn, mapping = aes(x = nitro, y = yield)) +
  geom_point()
```

## La fonction `lm`

```{r}
modlin_1 <- lm(yield ~ nitro, data = lasrosas.corn)
summary(modlin_1)
```

## `predict`

```{r, fig.height=4}
ggplot(data = lasrosas.corn, mapping = aes(x = nitro, y = yield)) +
  geom_point() +
  geom_line(data = tibble(nitro = lasrosas.corn$nitro, yield = predict(modlin_1)),
            size = 2, colour = "grey35")
```

## Analyse des r√©sidus (1/)

**R√©sidus**: erreurs du mod√®le, $\epsilon = y - \hat{y}$, fonction `residuals()`.

```{r}
res_df <- data.frame(nitro = lasrosas.corn$nitro,
                     residus_lm = residuals(modlin_1))
res_df %>% sample_n(4)
```

## Analyse des r√©sidus (2/)

- Pas de structure identifiable dans les r√©sidus
- Distribution normale

```{r, fig.height=4, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
ggplot(res_df, aes(x = nitro, y = residus_lm)) +
  geom_point() +
  labs(x = "Dose N", y = "R√©sidus") +
  geom_hline(yintercept = 0, col = "grey35", size = 2)
```

## Mod√©lisation lin√©aire multiple

$$ y = X \beta + \epsilon $$

## Mod√®les lin√©aires univari√©s avec variable cat√©gorielle **nominale**

`topo` est la classe topographique

```{r}
lasrosas.corn[c(1, 35, 51, 67), ]
```

## Matrice-mod√®le avec intercept

```{r}
model.matrix(~ topo, lasrosas.corn)[c(1, 35, 51, 67), ]
```

## Matrice-mod√®le sans intercept

```{r}
model.matrix(~ 0 + topo, lasrosas.corn)[c(1, 35, 51, 67), ]
```

## Mod√®le lin√©aire sur des cat√©gories = r√©gression multiple

```{r}
mod_cat <- lm(yield ~ topo, lasrosas.corn)
summary(mod_cat)
```

## Du mod√®le lin√©aire √† l'anova

```{r}
anova(mod_cat) # summary(aov(yield ~ topo, data = lasrosas.corn)
```

## Mod√®les lin√©aires univari√©s avec variable cat√©gorielle **ordinale**

```{r}
model.matrix(~ statut_o)
```

## R√©gression lin√©aire multiple

```{r}
modlin_mult <- lm(yield ~ lat + long + nitro + topo + bv,
                  data = lasrosas.corn)
summary(modlin_mult)
```

## Standardiser les donn√©es pour comparer les effets

```{r}
scale_vec <- function(x) as.vector(scale(x)) # la fonction scale g√©n√®re une matrice: nous d√©sirons un vecteur
lasrosas.corn_sc <- lasrosas.corn %>%
  mutate_at(c("lat", "long", "nitro", "bv"), scale_vec)
```

##

```{r}
modlin_mult_sc <- lm(yield ~ lat + long + nitro + topo + bv,
                     data = lasrosas.corn_sc)
summary(modlin_mult_sc)
```

## Int√©raction

Une int√©raction est une pente additionnelle informant sur l'effet statistique combin√© de deux variables.

Interface-formule: le symbole `:` appelle l'int√©raction et le synbole `*` appelle les effets simples et les int√©ractions.

```{r}
modlin_int_sc <- lm(yield ~ nitro*topo,
                    data = lasrosas.corn_sc)
summary(modlin_int_sc)
```

## Mod√®les lin√©aires g√©n√©ralis√©es

√âvaluer l'effet sur une variable enti√®re, bool√©enne, factorielle, etc.

```{r, fig.height=4, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
cochran.wireworms %>% ggplot(aes(x = trt, y = worms)) + geom_boxplot()
```

## La fonction `glm`

```{r}
modglm_1 <- glm(worms ~ trt, cochran.wireworms, family = "poisson")
summary(modglm_1)
```

## Sur graphique

```{r, fig.height=3, fig.width=6, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
intervals <- tibble(Estimate = coefficients(modglm_1), # [-1] enlever l'intercept
                    LL = confint(modglm_1)[, 1], # [-1, ] enlever la premi√®re ligne, celle de l'intercept
                    UL = confint(modglm_1)[, 2],
                    variable = names(coefficients(modglm_1))) 

ggplot(data = intervals, mapping = aes(x = Estimate, y = variable)) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_segment(mapping = aes(x = LL, xend = UL, 
                             y = variable, yend = variable)) +
  geom_point() +
  labs(x = "Coefficient", y = "")
```

## Mod√®les non-lin√©aires

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
engelstad.nitro %>%
  ggplot(aes(x = nitro, y = yield)) +
  facet_grid(year ~ loc) +
  geom_line() +
  geom_point() +
  ylim(c(0, 95))
```

## Mitscherlich

$$ y = A \left( 1 - e^{-R \left( E + x \right)} \right) $$

```{r, fig.height = 4, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
mitscherlich_f <- function(x, A, E, R) {
  A * (1 - exp(-R*(E + x)))
}

x <- seq(0, 350, by = 5)
y <- mitscherlich_f(x, A = 75, E = 30, R = 0.02)

ggplot(tibble(x, y), aes(x, y)) +
  geom_point(data = engelstad.nitro, aes(x = nitro, y = yield)) +
  geom_line() + ylim(c(0, 100)) +
  annotate("text", x = 300, y = 35, label = "A = 75,\nE = 30,\nR = 0.02")
```

## La focntion `nls`

```{r}
modnl_1 <-  nls(yield ~ A * (1 - exp(-R*(E + nitro))),
                data = engelstad.nitro,
                start = list(A = 75, E = 30, R = 0.02))
summary(modnl_1)
```

## R√©sidus

```{r, fig.height = 4}
tibble(res = residuals(modnl_1)) %>%
    ggplot(aes(x = res)) + geom_histogram(bins = 20)
```


## Mod√®les √† effets mixtes

√Ä la diff√©rence d'un effet fixe, un effet al√©atoire ($b$) sur des variables al√©atoires ($Z$) sera toujours distribu√© normalement avec une moyenne de 0 et une certaine variance. Pour un mod√®le √† intercept al√©atoire, nous aurons

$$ y = X \beta + Z b + \epsilon $$

Pour un mod√®le √† pente al√©atoire, nous aurons (√† v√©rifier)

$$ y = X \left( \beta + Zb \right) + \epsilon $$


## La fonction `lme` du module nlme

`random = ~ slope|intercept`

```{r}
mmodlin_1 <- lme(fixed = yield ~ lat + long + nitro + topo + bv,
                 random = ~ 1|year/rep,
                 data = lasrosas.corn)
summary(mmodlin_1)
```

## Effet al√©atoire

```{r}
ranef(mmodlin_1)
ranef(mmodlin_1)[[2]] %>% summarise(mean(`(Intercept)`))
```

## Mod√®les mixtes non-lin√©aires

```{r}
mm <- nlme(yield ~ A * (1 - exp(-R*(E + nitro))),
           data = engelstad.nitro, 
           start = c(A = 75, E = 30, R = 0.02), 
           fixed = list(A ~ 1, E ~ 1, R ~ 1), 
           random = A ~ year | loc)
summary(mm)
```

## Mod√®le mixte non-lin√©aire

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.keep='all'}
engelstad.nitro %>%
  ggplot(aes(x = nitro, y = yield)) +
  facet_grid(year ~ loc) +
  geom_line(data = tibble(nitro = engelstad.nitro$nitro,
                          yield = predict(mm, level = 0)),
            colour = "grey35") +
  geom_point() +
  ylim(c(0, 95))
```


## Mod√©lisation non-lin√©aire multiple

--> [Parent et al., 2018](https://www.frontiersin.org/articles/10.3389/fenvs.2017.00081/full)

## Objectifs sp√©cifiques (1/2)

√Ä la fin de ce chapitre, vous

- serez en mesure de d√©finir les concpets de base en statistique: population, √©chantillon, variable, probabilit√© et distribution
- serez en mesure de calculer des statistiques descriptives de base: moyenne et √©cart-type, quartiles, maximum et minimum
- comprendrez les notions de test d‚Äôhypoth√®se, d‚Äôeffet et de p-value, ainsi qu‚Äô√©viter les erreurs communes dans leur interpr√©tation

## Objectifs sp√©cifiques (2/2)

- saurez effectuer une mod√©lisation statistique lin√©aire simple, multiple et mixte, entre autre sur des cat√©gories
- saurez effectuer une mod√©lisation statistique non lin√©aire simple, multiple et mixte







