<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Analyse et modélisation d’agroécosystèmes sur R - 12&nbsp; Les séries temporelles</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./12-autoapprentissage.html" rel="next">
<link href="./10-imputation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./11-series-temporelles.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Les séries temporelles</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Analyse et modélisation d’agroécosystèmes sur R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/chavalli/ecologie-mathematique-R/tree/h2024" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Préface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">La science des données avec R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-tableaux.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Organisation des données et opérations sur des tableaux</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-visualisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Visualisation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Science ouverte et reproductibilité</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Introduction à Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07a-biostats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Biostatistiques</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07b-bayes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Introduction à l’analyse bayésienne en écologie</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-explorer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Explorer R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-ordination.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Association, partitionnement et ordination</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-imputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Détection de valeurs aberrantes et imputation de données manquantes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-series-temporelles.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Les séries temporelles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-autoapprentissage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Introduction à l’autoapprentissage</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-donnees-spatiales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Les données géospatiales</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-modelisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Modélisation de mécanismes écologiques</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#op%C3%A9rations-sur-les-donn%C3%A9es-temporelles" id="toc-opérations-sur-les-données-temporelles" class="nav-link active" data-scroll-target="#op%C3%A9rations-sur-les-donn%C3%A9es-temporelles"><span class="header-section-number">12.1</span> Opérations sur les données temporelles</a></li>
  <li>
<a href="#analyse-de-s%C3%A9ries-temporelles" id="toc-analyse-de-séries-temporelles" class="nav-link" data-scroll-target="#analyse-de-s%C3%A9ries-temporelles"><span class="header-section-number">12.2</span> Analyse de séries temporelles</a>
  <ul class="collapse">
<li><a href="#cr%C3%A9er-et-visualiser-des-s%C3%A9ries-temporelles" id="toc-créer-et-visualiser-des-séries-temporelles" class="nav-link" data-scroll-target="#cr%C3%A9er-et-visualiser-des-s%C3%A9ries-temporelles"><span class="header-section-number">12.2.1</span> Créer et visualiser des séries temporelles</a></li>
  <li><a href="#structures-dans-les-s%C3%A9ries-temporelles" id="toc-structures-dans-les-séries-temporelles" class="nav-link" data-scroll-target="#structures-dans-les-s%C3%A9ries-temporelles"><span class="header-section-number">12.2.2</span> Structures dans les séries temporelles</a></li>
  <li><a href="#lautocorr%C3%A9lation" id="toc-lautocorrélation" class="nav-link" data-scroll-target="#lautocorr%C3%A9lation"><span class="header-section-number">12.2.3</span> L’autocorrélation</a></li>
  <li><a href="#signification-statistique-dune-s%C3%A9rie-temporelle" id="toc-signification-statistique-dune-série-temporelle" class="nav-link" data-scroll-target="#signification-statistique-dune-s%C3%A9rie-temporelle"><span class="header-section-number">12.2.4</span> Signification statistique d’une série temporelle</a></li>
  </ul>
</li>
  <li>
<a href="#mod%C3%A9lisation-de-s%C3%A9ries-temporelles" id="toc-modélisation-de-séries-temporelles" class="nav-link" data-scroll-target="#mod%C3%A9lisation-de-s%C3%A9ries-temporelles"><span class="header-section-number">12.3</span> Modélisation de séries temporelles</a>
  <ul class="collapse">
<li><a href="#m%C3%A9thode-na%C3%AFve" id="toc-méthode-naïve" class="nav-link" data-scroll-target="#m%C3%A9thode-na%C3%AFve"><span class="header-section-number">12.3.1</span> Méthode naïve</a></li>
  <li><a href="#m%C3%A9thode-ses" id="toc-méthode-ses" class="nav-link" data-scroll-target="#m%C3%A9thode-ses"><span class="header-section-number">12.3.2</span> Méthode SES</a></li>
  <li><a href="#la-m%C3%A9thode-arima" id="toc-la-méthode-arima" class="nav-link" data-scroll-target="#la-m%C3%A9thode-arima"><span class="header-section-number">12.3.3</span> La méthode ARIMA</a></li>
  <li><a href="#les-mod%C3%A8les-dynamiques" id="toc-les-modèles-dynamiques" class="nav-link" data-scroll-target="#les-mod%C3%A8les-dynamiques"><span class="header-section-number">12.3.4</span> Les modèles dynamiques</a></li>
  <li><a href="#les-mod%C3%A8les-%C3%A0-saisonnalit%C3%A9-complexe" id="toc-les-modèles-à-saisonnalité-complexe" class="nav-link" data-scroll-target="#les-mod%C3%A8les-%C3%A0-saisonnalit%C3%A9-complexe"><span class="header-section-number">12.3.5</span> Les modèles à saisonnalité complexe</a></li>
  <li><a href="#autres-m%C3%A9thodes" id="toc-autres-méthodes" class="nav-link" data-scroll-target="#autres-m%C3%A9thodes"><span class="header-section-number">12.3.6</span> Autres méthodes</a></li>
  </ul>
</li>
  <li><a href="#pour-terminer" id="toc-pour-terminer" class="nav-link" data-scroll-target="#pour-terminer"><span class="header-section-number">12.4</span> Pour terminer…</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-temps" class="quarto-section-identifier"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Les séries temporelles</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><hr>
<p><strong>Objectifs spécifiques</strong>:</p>
<p>À la fin de ce chapitre, vous</p>
<ul>
<li>saurez comment importer et manipuler des données temporelles (utiliser le format de date, filtrer, effectuer des sommaires, agréger des données, etc.)</li>
<li>effectuer une régression sur une série temporelle</li>
</ul>
<hr>
<p>Les séries temporelles (ou chronologiques) sont des données associées à des indices temporels de tout ordre de grandeur: seconde, minute, heure, jour, mois, année, etc. En analyse de série temporelle, le temps est une variable explicative (ou dépendante) incontournable. L’émergence de cycles est une particularité des séries temporelles. Ceux-ci peuvent être analysés en vue d’en déterminer la tendance. Les séries temporelles peuvent également être modélisées en vue d’effectuer des prévisions.</p>
<p><img src="https://media.giphy.com/media/495yjUBKN7TE6fr5vq/giphy.gif" class="img-fluid"></p>
<p>Source: Scène de Back to the future, Robert Zemeckis et and Bob Gale, 1985</p>
<p>Nous allons couvrir les concepts de base en analyse et modélisation de séries temporelles. Mais avant cela, voyons comment les données temporelles sont manipulées en R.</p>
<p>Cette section est basée sur le livre <em>Forecasting: Principles and Practice</em>, de Rob J. Hyndman et George Athanasopoulos, qui peut être entièrement <a href="https://otexts.com/fpp3/">consulté gratuitement en ligne</a>, ainsi que le cours associé sur la plateforme d’apprentissage <a href="https://campus.datacamp.com/courses/forecasting-using-r">DataCamp</a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-ts-fpp3" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ts-fpp3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/09_fpp3_cover.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:30.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ts-fpp3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.1: <a href="https://otexts.com/fpp3/"><em>Forecasting: principles and practice, 3rd edition</em>, de Rob J. Hyndman et George Athanasopoulos</a>.
</figcaption></figure>
</div>
</div>
</div>
<section id="opérations-sur-les-données-temporelles" class="level2" data-number="12.1"><h2 data-number="12.1" class="anchored" data-anchor-id="opérations-sur-les-données-temporelles">
<span class="header-section-number">12.1</span> Opérations sur les données temporelles</h2>
<p>Le débit de la <a href="https://fr.wikipedia.org/wiki/Rivi%C3%A8re_Chaudi%C3%A8re">rivière Chaudière</a>, dont l’exutoire se situe près de Québec, sur la rive Sud du fleuve Saint-Laurent, est mesuré depuis 1915.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://tidyverse.tidyverse.org">"tidyverse"</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.0     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/023402_Q.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 34700 Columns: 4
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (1): Remarque
dbl  (2): Station, Débit
date (1): Date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>La fonction <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code> détecte automatiquement que la colonne <code>Date</code> est une date.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">hydro</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 34,700
Columns: 4
$ Station  &lt;dbl&gt; 23402, 23402, 23402, 23402, 23402, 23402, 23402, 23402, 23402…
$ Date     &lt;date&gt; 1915-02-27, 1915-02-28, 1915-03-01, 1915-03-02, 1915-03-03, …
$ Débit    &lt;dbl&gt; 538.0, 377.0, 269.0, 345.0, 269.0, 334.0, 269.0, 269.0, 269.0…
$ Remarque &lt;chr&gt; "MC", "MC", "MC", "MC", "MC", "MC", "MC", "MC", "MC", "MC", "…</code></pre>
</div>
</div>
<p>Le débit de la rivière Chaudière peut être exploré graphiquement.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">`Débit`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-plot-hydro-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On observe des données sont manquantes de la fin des années 1920 à la fin des années 1930. Autrement, il est difficile de visualiser la structure du débit en fonction du temps, notamment si le débit suit des cycles réguliers. On pourra isoler les données depuis 2014.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2014-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">`Débit`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-plot-hydro2014-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>R comprend la fonction <code><a href="https://rdrr.io/r/base/as.Date.html">as.Date()</a></code>, où l’argument <code>format</code> décrit la manière avec laquelle la date est exprimée.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"1999/03/29"</span>, format <span class="op">=</span> <span class="st">"%Y/%m/%d"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1999-03-29"</code></pre>
</div>
</div>
<p>L’argument <code>x</code> peut aussi bien être une chaîne de caractères qu’un vecteur où l’on retrouve plusieurs chaînes de caractères exprimant un format de date commun. La fonction <code><a href="https://rdrr.io/r/base/as.Date.html">as.Date()</a></code> permet ainsi de transformer des caractères en date si <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code> ne le détecte pas automatiquement. Ce format peut prendre la forme désirée, dont les paramètres sont listés sur la <a href="https://rdrr.io/r/base/strptime.html">page d’aide de la fonction <code>strptime()</code></a>. Toutefois, le plus petit incrément de temps accepté par <code><a href="https://rdrr.io/r/base/as.Date.html">as.Date()</a></code> est le jour: <code><a href="https://rdrr.io/r/base/as.Date.html">as.Date()</a></code> exclut les heures, minutes et secondes. Le module <a href="https://lubridate.tidyverse.org/"><strong><code>lubridate</code></strong></a>, issu du <em>tidyverse</em>, permet quant à lui de manipuler avec plus de grâce les formats de date standards, incluant les dates et les heures: <strong><code>lubridate</code></strong> sera préféré dans ce chapitre.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2011-02-19 09:14:00 UTC"</code></pre>
</div>
</div>
<p>Plusieurs autres formats standards sont présentés sur un <a href="https://rawgit.com/rstudio/cheatsheets/master/lubridate.pdf">aide-mémoire de <strong><code>lubridate</code></strong></a>. Si vos données comprennent des formats de date non standard, vous pourrez utiliser la fonction <code><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXlt()</a></code>, mais il pourrait être préférable de standardiser les dates <em>a priori</em>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-ts-lubridate-cs" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ts-lubridate-cs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/09_lubridate-cheatsheet-thumbs.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ts-lubridate-cs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.2: Aide-mémoire du module <a href="https://rawgit.com/rstudio/cheatsheets/master/lubridate.pdf">lubridate</a>.
</figcaption></figure>
</div>
</div>
</div>
<p>Le module <strong><code>lubridate</code></strong> rend possible l’extraction de la date (<code><a href="https://lubridate.tidyverse.org/reference/date.html">date()</a></code>), de l’année (<code><a href="https://lubridate.tidyverse.org/reference/year.html">year()</a></code>), du mois (<code><a href="https://lubridate.tidyverse.org/reference/month.html">month()</a></code>), du jour de la semaine (<code><a href="https://lubridate.tidyverse.org/reference/day.html">wday()</a></code>), du jour julien (<code><a href="https://lubridate.tidyverse.org/reference/day.html">yday()</a></code>), etc. pour plus d’options, voir <a href="https://rawgit.com/rstudio/cheatsheets/master/lubridate.pdf">l’aide-mémoire de <strong><code>lubridate</code></strong></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">date_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="st">"2019-03-14 09:14:00"</span><span class="op">)</span></span>
<span><span class="va">date_1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/date.html">date</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2019-03-14"</code></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">date_1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">date_1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">yday</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 73</code></pre>
</div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">date_1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">wday</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5</code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">date_1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">seconds</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1552554840S"</code></pre>
</div>
</div>
<p>Ces extractions peuvent être utilisées dans des suites d’opérations (<em>pipelines</em>). Par exemple, si nous désirons obtenir le débit mensuel moyen de la rivière Chaudière depuis 1990, nous pouvons créer une nouvelle colonne <code>Year</code> et une autre <code>Month</code> avec la fonction <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, effectuer un filtre sur l’année, regrouper par mois pour obtenir le sommaire en terme de moyenne, puis lancer le graphique.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro_month</span> <span class="op">&lt;-</span> <span class="va">hydro</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Date</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         Month <span class="op">=</span> <span class="va">Date</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;=</span> <span class="fl">1990</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Month</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>MeanFlow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">`Débit`</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hydro_month</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Month</span>, y<span class="op">=</span><span class="va">MeanFlow</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-extract-pipe-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On pourra aussi agréger par moyenne mensuelle en gardant l’année respective en créant une nouvelle colonne de date <code>YearMonth</code> qui permettra le regroupement avec <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>, puis créer plusieurs facettes.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="va">Date</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         Month <span class="op">=</span> <span class="va">Date</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         YearMonth <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">Year</span>, <span class="st">"-"</span>, <span class="va">Month</span>, <span class="st">"-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&gt;=</span> <span class="fl">2010</span> <span class="op">&amp;</span> <span class="va">Year</span> <span class="op">&lt;</span> <span class="fl">2018</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">YearMonth</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>`Débit` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">`Débit`</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">YearMonth</span>, y<span class="op">=</span><span class="va">`Débit`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Year</span>, scales <span class="op">=</span> <span class="st">"free_x"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Year'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-group-by-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Il est possible d’effectuer des opérations mathématiques sur des données temporelles. Par exemple, ajouter 10 jours à chaque date.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>DateOffset <span class="op">=</span> <span class="va">Date</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  Station Date       Débit Remarque DateOffset
    &lt;dbl&gt; &lt;date&gt;     &lt;dbl&gt; &lt;chr&gt;    &lt;date&gt;    
1   23402 1915-02-27   538 MC       1915-03-09
2   23402 1915-02-28   377 MC       1915-03-10
3   23402 1915-03-01   269 MC       1915-03-11
4   23402 1915-03-02   345 MC       1915-03-12
5   23402 1915-03-03   269 MC       1915-03-13</code></pre>
</div>
</div>
<p>Pour effectuer des opérations sur des incréments inférieurs aux jours, il faut s’assurer que le type des données temporelles soit bien <code>POSIXct</code>, et non pas <code>Date</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Date"</code></pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">&lt;-</span> <span class="va">hydro</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html">as_datetime</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hydro</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "POSIXct" "POSIXt" </code></pre>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydro</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>DateOffset <span class="op">=</span> <span class="va">Date</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">seconds</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  Station Date                Débit Remarque DateOffset         
    &lt;dbl&gt; &lt;dttm&gt;              &lt;dbl&gt; &lt;chr&gt;    &lt;dttm&gt;             
1   23402 1915-02-27 00:00:00   538 MC       1915-02-27 00:00:10
2   23402 1915-02-28 00:00:00   377 MC       1915-02-28 00:00:10
3   23402 1915-03-01 00:00:00   269 MC       1915-03-01 00:00:10
4   23402 1915-03-02 00:00:00   345 MC       1915-03-02 00:00:10
5   23402 1915-03-03 00:00:00   269 MC       1915-03-03 00:00:10</code></pre>
</div>
</div>
</section><section id="analyse-de-séries-temporelles" class="level2" data-number="12.2"><h2 data-number="12.2" class="anchored" data-anchor-id="analyse-de-séries-temporelles">
<span class="header-section-number">12.2</span> Analyse de séries temporelles</h2>
<p>Tout comme c’est le cas de nombreux sujet couverts lors de ce cours, l’analyse et modélisation de séries temporelles est un domaine d’étude en soi. Nous allons nous restreindre ici aux séries temporelles consignées à fréquence régulière. Les exemples d’analyses et modélisation de séries temporelles sont typiquement des données économiques, bien que les principes qui les guident sont les mêmes qu’en d’autres domaines. Cette section est vouée à l’analyse, alors que la prochaine est vouée à la modélisation.</p>
<p>Par exemple, voici une série temporelle économique typique, qui exprime le volume de production mensuelle de gaz au Canada, entre janvier 1960 et février 2005.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/robjhyndman/fpp3package">"fpp3"</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────────────── fpp3 0.5 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ tsibble     1.1.4     ✔ fable       0.3.4
✔ tsibbledata 0.4.1     ✔ fabletools  0.4.1
✔ feasts      0.3.2     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────────────── fpp3_conflicts ──
✖ lubridate::date()    masks base::date()
✖ dplyr::filter()      masks stats::filter()
✖ tsibble::intersect() masks base::intersect()
✖ tsibble::interval()  masks lubridate::interval()
✖ dplyr::lag()         masks stats::lag()
✖ tsibble::setdiff()   masks base::setdiff()
✖ tsibble::union()     masks base::union()</code></pre>
</div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"canadian_gas"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">canadian_gas</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Plot variable not specified, automatically selected `.vars = Volume`</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-load-ts-packages-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On y détecte une tendance générale d’augmentation, ainsi que des tendances cycliques. On verra plus loin comment prédire des occurrences futures, ainsi que l’incertitude de ces prédictions, à partir des données consignées.</p>
<p>Jusqu’à présent, nous avons travaillé avec des tableaux de données incluant une colonne en format date. Nous allons maintenant travailler avec des séries temporelles telles que représentées en R. Vous avez peut-être remarqué le chargement du module <a href="https://github.com/robjhyndman/fpp3package"><strong><code>fpp3</code></strong></a> dans le dernier bloc de code : Il s’agit d’un méta-module, un peu comme <strong><code>tidyverse</code></strong>, développé par les auteurs du manuel <a href="https://otexts.com/fpp3/"><em>Forecasting: principles and practice, 3rd edition</em>, de Rob J. Hyndman et George Athanasopoulos</a>, la référence principale de ce chapitre.</p>
<p>Par défaut, ce méta-module charge certains des modules de tidyverse (tibble, dplyr, tidyr, lubridate et ggplot2) avec lesquels vous devriez maintenant être à l’aise et qui devraient déjà faire partie de votre flux de travail. De plus, les nouveaux modules <strong><code>tsibble</code></strong>, <strong><code>feasts</code></strong> et <strong><code>fable</code></strong> sont introduits; nous verrons dans ce chapitre ce qu’ils permettent d’accomplir pour l’analyse et la modélisation des séries temporelles.</p>
<section id="créer-et-visualiser-des-séries-temporelles" class="level3" data-number="12.2.1"><h3 data-number="12.2.1" class="anchored" data-anchor-id="créer-et-visualiser-des-séries-temporelles">
<span class="header-section-number">12.2.1</span> Créer et visualiser des séries temporelles</h3>
<p>L’information consignée dans une série temporelle inclut nécessairement un indice temporel associé à au moins une variable. En R, cette information est consignée dans un objet de type <code>ts</code>, pour <em>time series</em>. Ce format est utilisé par le module <code>forecast</code>, qui était utilisé dans l’ancienne version de ce manuel. Prenons une mesure quelconque prise à chaque trimestre de l’année 2018.</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">96683</span><span class="op">)</span></span>
<span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2018-01-01"</span>, <span class="st">"2018-04-01"</span>, <span class="st">"2018-07-01"</span>, <span class="st">"2018-10-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mesure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">mesure_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html">ts</a></span><span class="op">(</span><span class="va">mesure</span>, start <span class="op">=</span> <span class="va">date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, frequency <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">mesure_ts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Qtr1     Qtr2     Qtr3     Qtr4
17532 7.175836 3.646285 6.631606 8.648371</code></pre>
</div>
</div>
<p>L’argument <code>start</code> est la date de la première observation et <code>frequency</code> est le nombre d’observations par unité temporelle, ici l’année.</p>
<p>Le module <strong><code>tsibble</code></strong>, chargé automatiquement avec le métamodule <strong><code>fpp3</code></strong>, vient remplacer le format <code>ts</code> par un format <code>tbl_ts</code>. C’est un peu l’équivalent de <code>tibble</code> de tidyverse qui remplace les <code>data.frame</code>. Le format tsibble sera utilisé pour la modélisation avec <code>fable</code> un peu plus loin. Ainsi, si on utilise <code>tsibble</code> au lieu de <code>ts</code> :</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">96683</span><span class="op">)</span></span>
<span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2018-01-01"</span>, <span class="st">"2018-04-01"</span>, <span class="st">"2018-07-01"</span>, <span class="st">"2018-10-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mesure_ts</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mesure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using `&lt;date&gt;` as index variable.</code></pre>
</div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mesure_ts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 4 x 2 [1D]
  `&lt;date&gt;`   mesure
  &lt;date&gt;      &lt;dbl&gt;
1 2018-01-01   7.18
2 2018-04-01   3.65
3 2018-07-01   6.63
4 2018-10-01   8.65</code></pre>
</div>
</div>
<p>L’avantage est qu’on peut directement utiliser un tableau <code>tibble</code> et indiquer comme index la variable correspondant à l’unité de temps souhaitée. Le format tsibble est aussi un format de tableau et on préserve la variable de date, ce qui rendra la visualisation et les traitements plus intuitifs par la suite. De plus, la méthode avec tsibble respecte la méthode <code>tidy</code> mise de l’avant dans ce cours, donc je vous suggère fortement de l’utiliser.</p>
<p>Il est à noter qu’il existe d’autres méthodes pour gérer les séries temporelles, par exemple directement avec le format tibble avec les modules <code>timetk</code> et <code>modeltime</code> qui respectent aussi la méthode tidy. Toutefois, ces modules ne seront pas présentés dans ce cours.</p>
<p>Reprenons maintenant les données hydrologiques. J’ai auparavant recueilli des données météo avec <strong><code>weathercan</code></strong> (disponibles seulement depuis 1998) et fusionné avec le tableau <code>hydro</code>. Pour accélérer la procédure, j’ai enregistré les données dans un fichier RData. De facto, ne gardons que les données disponibles entre 1998 et 2008, ainsi que les colonnes désignant la date, le débit, les précipitations totales et la température.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 3,653
Columns: 4
$ Date         &lt;date&gt; 1998-01-01, 1998-01-02, 1998-01-03, 1998-01-04, 1998-01-…
$ Débit        &lt;dbl&gt; 15.70, 16.00, 17.40, 19.30, 23.20, 29.00, 58.85, 65.80, 7…
$ total_precip &lt;dbl&gt; 1.6, 2.8, 2.2, 0.0, 5.8, 11.8, 2.4, 19.2, 11.6, 2.6, 0.0,…
$ mean_temp    &lt;dbl&gt; -21.1, -8.9, 1.9, -3.2, -8.7, -8.0, -7.4, -6.3, -5.4, -1.…</code></pre>
</div>
</div>
<p>Pour créer une série temporelle de type <code>ts</code>, je dois enlever la date, démarrer au premier événement de 1998, et chaque incrément a une fréquence de 1/365.25 unités depuis 1998 (il y a en moyenne 365.25 jours par an).</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydrometeo_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html">ts</a></span><span class="op">(</span><span class="va">hydrometeo</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Date</span><span class="op">)</span>,</span>
<span>                    start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hydrometeo</span><span class="op">$</span><span class="va">Date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    frequency <span class="op">=</span> <span class="fl">365.25</span><span class="op">)</span></span>
<span><span class="va">hydrometeo_ts</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Débit total_precip mean_temp
[1,]  15.7          1.6     -21.1
[2,]  16.0          2.8      -8.9
[3,]  17.4          2.2       1.9
[4,]  19.3          0.0      -3.2
[5,]  23.2          5.8      -8.7</code></pre>
</div>
</div>
<p>Avec <code>tsibble</code>, on n’a qu’à sélectionner la variable de date comme index.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydrometeo_ts</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">hydrometeo</span>, index <span class="op">=</span> <span class="va">Date</span><span class="op">)</span></span>
<span><span class="va">hydrometeo_ts</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 5 x 4 [1D]
  Date       Débit total_precip mean_temp
  &lt;date&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;
1 1998-01-01  15.7          1.6     -21.1
2 1998-01-02  16            2.8      -8.9
3 1998-01-03  17.4          2.2       1.9
4 1998-01-04  19.3          0        -3.2
5 1998-01-05  23.2          5.8      -8.7</code></pre>
</div>
</div>
<p>Pour visualiser les séries temporelles, on peut alors procéder de la même façon que nous avons vu précédemment dans le cours.</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydrometeo_ts</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">Date</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hydrometeo-ts-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Il est aussi possible de filtrer des séries temporelles en mode tidyverse, disons pour utiliser les 10 premiers jours de l’an 2000.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydrometeo_ts</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2000</span> <span class="op">&amp;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">yday</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 10 x 4 [1D]
   Date       Débit total_precip mean_temp
   &lt;date&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;
 1 2000-01-01  44.3          2.8     -10  
 2 2000-01-02  42.4          9.4      -5.6
 3 2000-01-03  40.7          0        -5.5
 4 2000-01-04  43.6         23.5      -0.9
 5 2000-01-05  49.0          0        -8.8
 6 2000-01-06  58.9          0       -12.9
 7 2000-01-07  49.1          1.2      -4.6
 8 2000-01-08  44.4          3.8     -10.5
 9 2000-01-09  40.6          6.8      -4.9
10 2000-01-10  38.1          7        -2.3</code></pre>
</div>
</div>
<p>Voyons l’évolution mensuelle des débits.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hydrometeo_monthly</span> <span class="op">&lt;-</span> <span class="va">hydrometeo</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>date_month <span class="op">=</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-month.html">yearmonth</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>`Débit` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">`Débit`</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># moyenne débit</span></span>
<span>                   total_precip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_precip</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># somme débit</span></span>
<span>                   mean_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mean_temp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="co"># moyenne temp</span></span>
<span>  <span class="fu">tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">date_month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On peut maintenant visualiser les tendances cycliques avec <code><a href="https://feasts.tidyverts.org/reference/gg_season.html">feasts::gg_season()</a></code> et <code><a href="https://feasts.tidyverts.org/reference/gg_subseries.html">feasts::gg_subseries()</a></code>. Notez que j’utilise la fonction <code><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">cowplot::plot_grid()</a></code> pour arranger différents graphiques ggplot2 en une grille.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://wilkelab.org/cowplot/">"cowplot"</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attachement du package : 'cowplot'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>L'objet suivant est masqué depuis 'package:lubridate':

    stamp</code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ggA</span> <span class="op">&lt;-</span> <span class="va">hydrometeo_monthly</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gg_season</span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Mois"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ggB</span> <span class="op">&lt;-</span> <span class="va">hydrometeo_monthly</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gg_season</span><span class="op">(</span><span class="va">`Débit`</span>, polar <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Mois"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ggC</span> <span class="op">&lt;-</span> <span class="va">hydrometeo_monthly</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">gg_subseries</span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Mois"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">left_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span><span class="va">ggA</span>, <span class="va">ggC</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'A'</span>, <span class="st">'C'</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span><span class="va">left_col</span>, <span class="va">ggB</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">''</span>, <span class="st">'B'</span><span class="op">)</span>, </span>
<span>          ncol <span class="op">=</span> <span class="fl">2</span>, rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hydrometeo-cycles-viz-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
</section><section id="structures-dans-les-séries-temporelles" class="level3" data-number="12.2.2"><h3 data-number="12.2.2" class="anchored" data-anchor-id="structures-dans-les-séries-temporelles">
<span class="header-section-number">12.2.2</span> Structures dans les séries temporelles</h3>
<p>Les séries temporelles sont susceptibles d’être caractérisées par des structures communément observées.</p>
<ul>
<li>La <strong>tendance</strong> est une structure décrivant la hausse ou la baisse à <em>long terme</em> d’une variable numérique.</li>
<li>La <strong>fluctuation saisonnière</strong> est une structure périodique, qui oscille autour de la tendance générale de manière régulière selon le calendrier.</li>
<li>La <strong>fluctuation cyclique</strong> est aussi une structure périodique, mais irrégulière (par exemple, les oscillations peuvent durer parfois 2 ans, parfois 3). Les fluctuations cycliques sont souvent de plus longue fréquence que les fluctuations saisonnières, et leur irrégularité rend les prédictions plus difficiles.</li>
</ul>
<p><strong>Note</strong>. Une tendance détectée sur une période de temps trop courte peut s’avérer être une fluctuation.</p>
<p>La <a href="#fig-ts-lynx-trend" class="quarto-xref">Figure&nbsp;<span>12.3</span></a> montre différentes structures. La <a href="#fig-ts-lynx-trend-1" class="quarto-xref">Figure&nbsp;<span>12.3 (a)</span></a> montre une tendance croissante de la production de gaz au Canada, ainsi que des fluctuations saisonnières. La <a href="#fig-ts-lynx-trend-2" class="quarto-xref">Figure&nbsp;<span>12.3 (b)</span></a> montre des fluctuations saisonnières des températures quotidiennes moyennes à l’Université Laval, sans présenter de tendance claire. La figure <a href="#fig-ts-lynx-trend-3" class="quarto-xref">Figure&nbsp;<span>12.3 (c)</span></a> montre des fluctuations cycliques du nombre de lynx trappés par année au Canada de 1821 à 1934, sans non plus présenter de tendance claire. Les cycles sont conséquents des mécanismes de dynamique des populations (plus de proies entraînent plus de prédateurs, plus de prédateurs entraînent moins de proies, moins de proies entraîne moins de prédateurs, moins de prédateurs entraîne plus de proies, etc.), que nous couvrirons au <a href="14-modelisation.html" class="quarto-xref">chapitre&nbsp;<span>15</span></a>.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"lynx"</span><span class="op">)</span></span>
<span><span class="va">canadian_gas</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">Volume</span><span class="op">)</span></span>
<span><span class="va">hydrometeo_ts</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">mean_temp</span><span class="op">)</span></span>
<span><span class="va">lynx</span> <span class="op">|&gt;</span> <span class="fu">as_tsibble</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-ts-lynx-trend" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ts-lynx-trend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ts-lynx-trend" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-ts-lynx-trend-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-ts-lynx-trend-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-series-temporelles_files/figure-html/fig-ts-lynx-trend-1.png" class="img-fluid figure-img" data-ref-parent="fig-ts-lynx-trend" width="1152">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-ts-lynx-trend-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Production de gaz
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ts-lynx-trend" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-ts-lynx-trend-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-ts-lynx-trend-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-series-temporelles_files/figure-html/fig-ts-lynx-trend-2.png" class="img-fluid figure-img" data-ref-parent="fig-ts-lynx-trend" width="1152">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-ts-lynx-trend-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Hydro-météo
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ts-lynx-trend" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-ts-lynx-trend-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-ts-lynx-trend-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11-series-temporelles_files/figure-html/fig-ts-lynx-trend-3.png" class="img-fluid figure-img" data-ref-parent="fig-ts-lynx-trend" width="1152">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-ts-lynx-trend-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Lynx
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ts-lynx-trend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.3: Identification des tendances et fluctuations dans des séries temporelles
</figcaption></figure>
</div>
<p>Il est possible que l’on retrouve une hiérarchie dans les fluctuations, c’est-à-dire que de grandes fluctuations (saisonnières ou cycliques) peuvent contenir des fluctuations sur des incréments de temps plus petits, un peu comme sur la <a href="#fig-ts-lynx-trend-1" class="quarto-xref">Figure&nbsp;<span>12.3 (a)</span></a> où, en plus des fluctuations saisonnières et de la tendance croissante, on pourrait voir une oscillation sur un cycle d’environ 20 ans (mais il faudrait un plus long jeu de données pour confirmer ce cycle).</p>
<p>Dans certains cas, il peut être intéressant pour la visualisation de calculer la moyenne mobile, en utilisant par exemple la fonction <code><a href="https://slider.r-lib.org/reference/slide.html">slider::slide_dbl()</a></code>. Ici, pour estimer la tendance des données annuelles à partir de données mensuelles, on effectue une moyenne mobile double (première sur 12 mois, puis la deuxième pour considérer l’année précédente).</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">canadian_gas_ma</span> <span class="op">&lt;-</span> <span class="va">canadian_gas</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    vol_12m <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op">(</span><span class="va">Volume</span>, <span class="va">mean</span>,</span>
<span>                .before <span class="op">=</span> <span class="fl">5</span>, .after <span class="op">=</span> <span class="fl">6</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    vol_ma <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op">(</span><span class="va">vol_12m</span>, <span class="va">mean</span>,</span>
<span>                .before <span class="op">=</span> <span class="fl">1</span>, .after <span class="op">=</span> <span class="fl">0</span>, .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">canadian_gas_ma</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">Volume</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">vol_ma</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#228866"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-gas-trend-ma-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="lautocorrélation" class="level3" data-number="12.2.3"><h3 data-number="12.2.3" class="anchored" data-anchor-id="lautocorrélation">
<span class="header-section-number">12.2.3</span> L’autocorrélation</h3>
<p>Lorsque les données présentent des fluctuations (saisonnières ou cycliques), le graphique d’autocorrélation montrera un sommet aux étapes des cycles ou des saisons. Le graphique d’autocorrélation de données aléatoires (aussi appelées <em>bruit blanc</em>) montrera des sommets sans signification.</p>
<p>Un graphique de retardement (<em>lag plot</em>) met successivement en relation <span class="math inline">\(y_t\)</span> avec <span class="math inline">\(y_{t-p}\)</span>. Un graphique d’autocorrélation est la corrélation entre <span class="math inline">\(y_t\)</span>, <span class="math inline">\(y_{t-1}\)</span>, <span class="math inline">\(y_{t-2}\)</span>, etc. Une graphique de retardement donne un aperçu de la dépendance d’une variable selon ses valeurs passées. Les graphiques de retardement de données ayant une forte tendance présenteront des points près de la diagonale, tandis que ceux montrant des données fluctuantes de type sinusoïdal présenteront des points disposés de manière circulaire. Des données aléatoires, quant à elles, ne présenteront pas de structure de retardement facilement identifiable.</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">64301</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lynx_ts</span> <span class="op">&lt;-</span> <span class="va">lynx</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bruit_blanc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">114</span>, <span class="fl">0</span>, <span class="fl">6000</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">lynx_ts</span>, <span class="va">value</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Lynx: Série temporelle"</span><span class="op">)</span>,</span>
<span>          <span class="fu">ACF</span><span class="op">(</span><span class="va">lynx_ts</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Lynx: Autocorrélation"</span><span class="op">)</span>,</span>
<span>          <span class="fu">gg_lag</span><span class="op">(</span><span class="va">lynx_ts</span>, y <span class="op">=</span> <span class="va">value</span>, geom <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Lynx: Lag plot"</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">lynx_ts</span>, <span class="va">bruit_blanc</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Bruit blanc: Série temporelle"</span><span class="op">)</span>,</span>
<span>          <span class="fu">ACF</span><span class="op">(</span><span class="va">lynx_ts</span>, y <span class="op">=</span> <span class="va">bruit_blanc</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Bruit blanc: Autocorrélation"</span><span class="op">)</span>,</span>
<span>          <span class="fu">gg_lag</span><span class="op">(</span><span class="va">lynx_ts</span>, y <span class="op">=</span> <span class="va">bruit_blanc</span>, geom <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Bruit blanc: Lag plot"</span><span class="op">)</span>,</span>
<span>          ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-auto-correlation-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercice #1">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice #1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Créez, puis interprétez des graphiques <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code>, <code>ACF()</code> et <code>gg_lag()</code> pour les données <code>canadian_gas</code>.</p>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercice #2">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice #2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans la <a href="#fig-ts-exercice-viz" class="quarto-xref">Figure&nbsp;<span>12.4</span></a>, trouvez le graphique d’autocorrélation et le graphique de retardement correspondant à chaque série temporelle.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-ts-exercice-viz" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ts-exercice-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/09_exercice-plot.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ts-exercice-viz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.4: Exercice: Trouvez le graphique d’autocorrélation et le graphique de retardement correspondant à chaque série temporelle.
</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Réponse">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Réponse
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Réponse, voir <code>source("lib/09_exercice-hydrometeo.R")</code>:</p>
<ul>
<li>
<code>Débit</code>: A-B-C</li>
<li>
<code>total_precip</code>: B-A-A</li>
<li>
<code>mean_temp</code>: C-C-B</li>
</ul>
</div>
</div>
</div>
<hr></section><section id="signification-statistique-dune-série-temporelle" class="level3" data-number="12.2.4"><h3 data-number="12.2.4" class="anchored" data-anchor-id="signification-statistique-dune-série-temporelle">
<span class="header-section-number">12.2.4</span> Signification statistique d’une série temporelle</h3>
<p>J’ai précédemment introduit la notion de bruit blanc, qui est un signal ne contenant pas de structure, comme le grésillement d’une radio mal syntonisée. Nous avons vu au <a href="07a-biostats.html" class="quarto-xref">chapitre&nbsp;<span>7</span></a> que les tests d’hypothèse en statistiques fréquentielles visent entre autres à détecter la probabilité que les données soient générées par une distribution dont la tendance centrale est nulle. De même, pour les séries temporelles, il est possible de calculer la probabilité qu’un signal soit un bruit blanc. Deux outils peuvent nous aider à effectuer ce test: l’un est visuel, l’autre est sous forme de calcul.</p>
<p>Le graphique d’autocorrélation est à même d’inclure des seuils pour lesquels la corrélation est significative (lignes pointillées bleues). Par défaut, les intervalles de confiance sont situées à 0.95, ce qui signifie que les valeurs dépassant les intervalles de confiance sont considérées comme différentes, donc il est peu probable qu’elles proviennent d’un bruit blanc.</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ACF</span><span class="op">(</span><span class="va">lynx_ts</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Lynx: Autocorrélation"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-lynx-signif-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>L’analyse des seuils de signification de l’autocorrélation indique sur la possibilité de conduire la série temporelle vers un processus de modélisation prédictive. Dans l’exemple ci-dessus, on remarque qu’il existe des corrélations significatives pour un décalage de 4 à 6 données, mais que les données situées près les unes des autres pourraient être plus difficiles à modéliser.</p>
<p>Le test de Ljung-Box permet quant à lui de tester si la série temporelle entière peut être différenciée d’un bruit blanc.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lynx_ts</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">features</span><span class="op">(</span><span class="va">value</span>, <span class="va">ljung_box</span>, lag <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="co"># Méthode feats. pvalue = 0 car trop petit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  lb_stat lb_pvalue
    &lt;dbl&gt;     &lt;dbl&gt;
1    366.         0</code></pre>
</div>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">lynx_ts</span><span class="op">$</span><span class="va">value</span>, lag <span class="op">=</span> <span class="fl">20</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span> <span class="co"># Méthode classique R base</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Box-Ljung test

data:  lynx_ts$value
X-squared = 365.54, df = 20, p-value &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Dans ce cas, la probabilité que la série soit un bruit blanc est presque nulle.</p>
<p>Notons que les tests statistiques sont aussi valides sur les dérivées des séries temporelles. En outre, une dérivée première de la série temporelle sur la production de gaz devient une série temporelle de la variation de la production.</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">canadian_gas_diff</span> <span class="op">&lt;-</span> <span class="va">canadian_gas</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>volume_diff <span class="op">=</span> <span class="fu">difference</span><span class="op">(</span><span class="va">Volume</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">canadian_gas_diff</span>, <span class="va">volume_diff</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Restauration: Série temporelle"</span><span class="op">)</span>,</span>
<span>          <span class="fu">ACF</span><span class="op">(</span><span class="va">canadian_gas_diff</span>, y <span class="op">=</span> <span class="va">volume_diff</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Restauration: Autocorrélation"</span><span class="op">)</span>,</span>
<span>          <span class="fu">gg_lag</span><span class="op">(</span><span class="va">canadian_gas_diff</span>, y <span class="op">=</span> <span class="va">volume_diff</span>, geom <span class="op">=</span> <span class="st">"point"</span>, lags <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Restauration: Lag plot"</span><span class="op">)</span>,</span>
<span>          ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 rows containing missing values (gg_lag).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-diff-first-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">canadian_gas_diff</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">features</span><span class="op">(</span><span class="va">volume_diff</span>, <span class="va">ljung_box</span>, lag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  lb_stat lb_pvalue
    &lt;dbl&gt;     &lt;dbl&gt;
1    11.0  0.000910</code></pre>
</div>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">canadian_gas</span><span class="op">$</span><span class="va">Volume</span><span class="op">)</span>, lag <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Box-Ljung test

data:  diff(canadian_gas$Volume)
X-squared = 11.002, df = 1, p-value = 0.0009104</code></pre>
</div>
</div>
<p>Jusqu’à présent, nous nous sommes contentés d’observer des séries temporelles. Lançons-nous maintenant dans un domaine plus excitant.</p>
<p><img src="https://media.giphy.com/media/U7r30sy3u73Og/giphy.gif" class="img-fluid"></p>
<p>Source: Scène de Back to the future, Robert Zemeckis et and Bob Gale, 1985</p>
</section></section><section id="modélisation-de-séries-temporelles" class="level2" data-number="12.3"><h2 data-number="12.3" class="anchored" data-anchor-id="modélisation-de-séries-temporelles">
<span class="header-section-number">12.3</span> Modélisation de séries temporelles</h2>
<p>L’objectif général de la modélisation de séries temporelles est la prévision (<em>forecast</em>). La majorité des modèles se base sur des simulations de futurs possibles, desquels on pourra déduire une tendance centrale (<em>point forecast</em>) ainsi que des intervalles prévisionnels pour apprécier l’incertitude de la projection. Il est important d’insister sur le fait que la tendance centrale ne signifie pas que les données futures suivront cette tendance, mais plutôt que selon les données et le modèle, la moitié des données devrait se retrouver sous la ligne, et l’autre moitié au-dessus. De plus, la région de confiance définie par les intervalles prévisionnels signifient par exemple que 95% des points devraient se situer dans cette région.</p>
<p>Une manière d’évaluer la performance d’une prévision est de prévoir des données auparavant observées à partir des données qui les précèdent. Ces valeurs sont dites <em>lissées</em>. Tout comme c’est le cas en régression statistique, il est possible de calculer les résidus du modèle. Pour les régressions couvertes au <a href="07a-biostats.html" class="quarto-xref">chapitre&nbsp;<span>7</span></a>, nous déterminions la validité du modèle en vérifiant si les résidus étaient distribués normalement. Pour une série temporelle, on tend plutôt à vérifier si les résidus forment un bruit blanc, c’est-à-dire qu’ils ne sont pas corrélés. De plus, pour éviter d’être biaisés, leur moyenne doit être de 0. De manière complémentaire pour la validité des intervalles prévisionnels, mais non essentielle à la validité du modèle, les résidus devraient être distribués normalement et leur variance devrait être constante (<a href="https://otexts.com/fpp3/">Hyndman et Athanasopoulos, 2021</a>).</p>
<p>Il est possible qu’un modèle remplisse toutes ces conditions, mais que sa prévision soit médiocre. Comme nous le verrons également au <a href="12-autoapprentissage.html" class="quarto-xref">chapitre&nbsp;<span>13</span></a>, une prédiction ou une prévision issue d’un modèle ne peut pas être évaluée sur des données qui ont servi à lisser le modèle. <strong>Pour vérifier une prévision temporelle, il faut séparer les données en deux séries: une série d’entraînement et une série de test</strong> (<a href="#fig-ts-train-test" class="quarto-xref">Figure&nbsp;<span>12.5</span></a>).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-ts-train-test" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ts-train-test-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ts-train-test-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.5: Les points bleus désigne la série d’entraînement et les points rouges, la série de test. Source de l’image: <a href="https://otexts.com/fpp3/">Hyndman et Athanasopoulos, 2021</a>.
</figcaption></figure>
</div>
</div>
</div>
<p>La séparation dans le temps entre la série d’entraînement et la série de test se fait à votre convenance, selon la disponibilité des données. Vous aurez toutefois avantage à conserver davantage de données en entraînement (typiquement, 70%), et à tout le moins, séparer au moins une fluctuation saisonnière ou cyclique. La série d’entraînement servira à lisser le modèle pour en découvrir les possibles structures. La série de test servira à évaluer sa performance sur des données obtenues, mais inconnues du modèle pour vérifier les structures découvertes par le modèle. L’erreur prévisionnelle est la différence entre une donnée observée en test et sa prévision (l’équivalent des résidus, mais appliqués sur des données indépendantes du modèle). La performance d’une prévision peut être évaluée de différentes manières, mais l’erreur moyenne absolue échelonnée (<em>mean absolute scaled error</em>, MASE) est conseillée puisqu’elle ne dépend pas de la métrique de la quantité produite: plus la MASE se rapproche de zéro, meilleure est la prévision.</p>
<p>La prudence est de mise pour que les modèles de prédiction dans l’espace (<a href="13-donnees-spatiales.html" class="quarto-xref">chapitre&nbsp;<span>14</span></a>) ou dans différentes circonstances (<a href="12-autoapprentissage.html" class="quarto-xref">chapitre&nbsp;<span>13</span></a>)) ne soient pas extrapolées pas au-delà du nuage de points des données d’entraînement. Mais pour les modèles prévisionnels, nous ne connaissons pas le futur: on travaille nécessairement en extrapolation. C’est la raison pour laquelle la séparation entre l’entraînement et le test ne se fait pas au hasard comme pour les modèles d’autoapprentissage (<a href="12-autoapprentissage.html" class="quarto-xref">chapitre&nbsp;<span>13</span></a>). Puisque nous ne connaissons pas les données futures, la performance d’un modèle prévisionnel doit être évaluée pour sa capacité à extrapoler, et non pas à interpoler une année dont la mesure est inconnue entre un passé et un futur connus.</p>
<p>Plusieurs méthodes de prévision sont possibles. Nous en couvrirons 3 dans ce chapitre: la méthode naïve, la méthode SES et la méthode ARIMA. Nous allons couvrir les différents aspects de la modélisation des séries temporelles à travers l’utilisation de ces méthodes.</p>
<section id="méthode-naïve" class="level3" data-number="12.3.1"><h3 data-number="12.3.1" class="anchored" data-anchor-id="méthode-naïve">
<span class="header-section-number">12.3.1</span> Méthode naïve</h3>
<p>La méthode naïve définit la valeur suivante selon la valeur précédente (fonction <code><a href="https://fable.tidyverts.org/reference/RW.html">fable::NAIVE()</a></code>), ou la valeur de la saison précédente (fonction <code><a href="https://fable.tidyverts.org/reference/RW.html">fable::SNAIVE()</a></code>). Ces fonctions du module <strong><code>fable</code></strong> incluent un composante aléatoire pour simuler des occurrences futures selon des marches aléatoires (<em>random walks</em>), où chaque valeur suivante est simulée aléatoirement, considérant la valeur précédente. Pour appliquer ces fonctions, on utilise typiquement la fonction <code><a href="https://fabletools.tidyverts.org/reference/model.html">fabletools::model</a></code> qui permet d’estimer un ensemble de modèles sur des séries temporelles.</p>
<p>Nous tenterons de prévoir les débits de la rivière Chaudière. Ceux-ci étant caractérisé par des fluctuations saisonnières, mieux vaut utiliser <code>SNAIVE()</code>. Mais auparavant, séparons la série en série d’entraînement et série de test.</p>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_ts_train</span> <span class="op">&lt;-</span> <span class="va">hydrometeo_monthly</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date_month</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2006</span><span class="op">)</span></span>
<span><span class="va">flow_ts_test</span> <span class="op">&lt;-</span> <span class="va">hydrometeo_monthly</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date_month</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2006</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lançons la modélisation sur les données d’entraînement. la méthode <strong><code>fable</code></strong> permet rapidement de tester plusieurs modèles à la fois : Ici, on teste les modèles <code><a href="https://fable.tidyverts.org/reference/RW.html">fable::NAIVE</a></code> et <code><a href="https://fable.tidyverts.org/reference/RW.html">fable::SNAIVE</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Créer les modèles</span></span>
<span><span class="va">flow_fit</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">model</span><span class="op">(</span></span>
<span>    Naive <span class="op">=</span> <span class="fu">NAIVE</span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span>,</span>
<span>    SNaive <span class="op">=</span> <span class="fu">SNAIVE</span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># Générer les prédictions pour deux ans (24 mois)</span></span>
<span><span class="va">flow_fc</span> <span class="op">&lt;-</span> <span class="va">flow_fit</span> <span class="op">|&gt;</span> <span class="fu">forecast</span><span class="op">(</span>h <span class="op">=</span> <span class="fl">24</span><span class="op">)</span></span>
<span><span class="co"># Visualiser les prédictions</span></span>
<span><span class="va">flow_fc</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span>, level <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autolayer.html">autolayer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">flow_fit</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autolayer.html">autolayer</a></span><span class="op">(</span><span class="va">flow_ts_test</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Prédictions"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-naive-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Le graphique précédent montre que la prédiction naïve (en rose) prend bien la valeur observée juste avant (en noir) pour les données d’entraînement. Par contre, lorsqu’on arrive aux données de test à partir de 2006, la valeur devient constante puisqu’elle prend toujours la valeur directement avant.</p>
<p>Pour la méthode naïve saisonnière (en turquoise), on voit que la valeur prédite est celle provenant du cycle précédent. Dans le cas présent, la valeur est celle de l’année précédente à pareille date. Cette méthode est moins performante pour l’interpolation, mais de biens résultats pour les données de test puisqu’elle répète le cycle de la dernière année. On remarque toutefois une surestimation des pics, causés par la présence de très forts débits au printemps 2005.</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_fc</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.model</span> <span class="op">==</span> <span class="st">"SNaive"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">flow_ts_train</span>, <span class="va">flow_ts_test</span><span class="op">)</span>, level<span class="op">=</span><span class="fl">80</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-naive-fit-ic-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Somme toute, avec les intervalles de confiance à 80%, le modèle semble assez performant. Notons que la présence de débit négatifs pourrait être évitée en utilisant une transformation logarithmique du débit préalablement à la modélisation.</p>
<p>Voyons maintenant l’analyse des résidus avec la fonction <code><a href="https://feasts.tidyverts.org/reference/gg_tsresiduals.html">feasts::gg_tsresiduals()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">gg_tsresiduals</span><span class="op">(</span><span class="va">flow_fit</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-snaive-residuals-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_res</span> <span class="op">&lt;-</span> <span class="va">flow_fit</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">augment</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flow_res</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">features</span><span class="op">(</span><span class="va">.innov</span>, <span class="va">ljung_box</span>, lag <span class="op">=</span> <span class="fl">19</span><span class="op">)</span> <span class="co">#  lag : T (nb d'obs.) / 5 max, ou le nombre de cycles</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .model lb_stat lb_pvalue
  &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 SNaive    34.9    0.0143</code></pre>
</div>
</div>
<p>La <code>p-value</code> étant de 0.0143, il est peu probable que les résidus forment un bruit blanc. Les résidus contiennent de l’autocorrélation, ce qui devrait être évité. Ceci est toutefois dû à un seul point allant au-delà du seuil de 0.05 à 12 mois (un an), que l’on peut observer sur le graphique d’autocorrélation. Le graphique de la distribution des résidus montre des valeurs aberrantes, ainsi qu’une distribution plutôt pointue, qui donnerait un test de Kurtosis probablement élevé.</p>
<div class="cell">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/shapiro.test.html">shapiro.test</a></span><span class="op">(</span><span class="va">flow_res</span><span class="op">$</span><span class="va">.innov</span><span class="op">)</span> <span class="co"># non-normal si p-value &lt; seuil (0.05)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  flow_res$.innov
W = 0.93698, p-value = 0.0004733</code></pre>
</div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"e1071"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/e1071/man/kurtosis.html">kurtosis</a></span><span class="op">(</span><span class="va">flow_res</span><span class="op">$</span><span class="va">.innov</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># le résultat d'un test de kurtosis sur une distribution normale devrait être de 0.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.909277</code></pre>
</div>
</div>
<p>Pas de panique, les prédictions peuvent néanmoins être valides. Seulement, les intervalles prévisionnelles pourraient être trop vagues ou trop restreintes : à prendre avec des pincettes.</p>
<p>L’évaluation du modèle peut être effectuée avec la fonction <code><a href="https://generics.r-lib.org/reference/accuracy.html">fabletools::accuracy()</a></code>, qui détecte automatiquement la série d’entraînement et la série de test si on lui fournit la série entière (ici l’objet <code>hydrometeo_monthly</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">accuracy</span><span class="op">(</span><span class="va">flow_fc</span>, <span class="va">hydrometeo_monthly</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 10
  .model .type    ME  RMSE   MAE    MPE  MAPE  MASE RMSSE      ACF1
  &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
1 Naive  Test  30.4  104.   67.2 -51.0   90.7  1.23 1.30   0.236   
2 SNaive Test  -1.02  75.2  57.1  -2.65  59.1  1.05 0.937 -0.000685</code></pre>
</div>
</div>
<p>On voit que pour ce jeu de donnée, la méthode naïve saisonnière performe beaucoup mieux. Par contre, la méthode naïve est rarement utilisée en pratique autrement que comme standard par rapport auquel la performance d’autres modèles est évaluée.</p>
</section><section id="méthode-ses" class="level3" data-number="12.3.2"><h3 data-number="12.3.2" class="anchored" data-anchor-id="méthode-ses">
<span class="header-section-number">12.3.2</span> Méthode SES</h3>
<p>Alors que la méthode naïve donne une crédibilité complète à la valeur précédente (ou au cycle précédent), la méthode SES (<em>simple exponential smoothing</em>) donne aux valeurs précédentes des poids exponentiellement décroissants selon leur ancienneté. La prévision par SES sera une moyenne pondérée des dernières observations, en donnant plus de poids sur les observations plus rapprochées.</p>
<p>Mathématiquement, la méthode SES est décrite ainsi.</p>
<p><span class="math display">\[\hat{y}_{t + h|t} = \alpha y_t + \alpha\left( 1-\alpha \right) y_{t-1} + \alpha\left( 1-\alpha \right)^2 y_{t-2} + ...\]</span></p>
<p>où <span class="math inline">\(\hat{y}_{t + h|t}\)</span> est la prévision de <span class="math inline">\(y\)</span> au temps <span class="math inline">\(t + h|t\)</span>, qui est le décalage de <span class="math inline">\(h\)</span> à partir de la dernière mesure au temps <span class="math inline">\(t\)</span>. Le paramètre <span class="math inline">\(\alpha\)</span> prend une valeur de 0 à 1, et décrit la distribution des poids. Une valeur de <span class="math inline">\(\alpha\)</span> élevé donnera davantage de poids aux événements récents. La somme de tous poids <span class="math inline">\(\alpha\)</span> tend vers 1 lorsque les pas de temps précédents tendent vers l’<span class="math inline">\(\infty\)</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-ses-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Une autre manière d’exprimer l’équation est de la segmenter en deux: une pour la prévision en fonction du niveau (<em>level</em>, le modèle), une autre pour décrire comment le niveau change au fil du temps.</p>
<table class="table">
<thead><tr class="header">
<th>Description</th>
<th>Équation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Prévision</td>
<td><span class="math inline">\(\hat{y}_{t + h|t} = l_t\)</span></td>
</tr>
<tr class="even">
<td>Niveau</td>
<td><span class="math inline">\(l_t = \alpha y_t + \alpha\left( 1-\alpha \right) l_{t-1}\)</span></td>
</tr>
</tbody>
</table>
<p>Exprimée ainsi, la prévision n’exprimera aucune tendance ni fluctuation. Il s’agira d’une projection jusqu’à l’infini de la moyenne des observations précédentes pondérée par leur décalage.</p>
<section id="ses-de-base" class="level4" data-number="12.3.2.1"><h4 data-number="12.3.2.1" class="anchored" data-anchor-id="ses-de-base">
<span class="header-section-number">12.3.2.1</span> SES de base</h4>
<p>Prenons les <a href="https://data.giss.nasa.gov/gistemp/graphs/graph_data/Global_Mean_Estimates_based_on_Land_and_Ocean_Data/graph.txt">données de la NASA</a> sur l’indice de température terre-océan, qui décrit un décalage par rapport à la moyenne des températures globales observées entre de 1951 à 1980. La méthode SES est appelée par la fonction <code><a href="https://fable.tidyverts.org/reference/ETS.html">fable::ETS()</a></code>, de la même manière qu’on l’a fait précédemment avec la méthode naïve. Les modèles ETS (<em>error, trend and seasonnal</em>) permettent d’utiliser toutes les méthodes SES que nous présenterons. La liste exhaustive des différents paramètres pouvant être utilisés est présentée dans le manuel <a href="https://otexts.com/fpp3/taxonomy.html">Hyndman et Athanasopoulos (2021), chapitre 8.4</a></p>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">loti_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/09_nasa.csv"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">Year</span><span class="op">)</span></span>
<span><span class="co"># loti_ts &lt;- loti_ts |&gt; filter(Year &gt;= 1950)</span></span>
<span><span class="va">loti_train</span> <span class="op">&lt;-</span> <span class="va">loti_ts</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op">&lt;=</span> <span class="fl">2004</span><span class="op">)</span></span>
<span><span class="va">loti_ets</span> <span class="op">&lt;-</span> <span class="va">loti_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">ETS</span><span class="op">(</span><span class="va">LOTI</span> <span class="op">~</span> <span class="fu">error</span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">trend</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">season</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># La fonction ETS peut utiliser différents paramètres d'erreur, de tendance et de saisonnalité. Ici, aucune tendance (N) et aucune saisonnalité (N) ne sont considérées.</span></span>
<span><span class="va">loti_fc</span> <span class="op">&lt;-</span> <span class="va">loti_ets</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">forecast</span><span class="op">(</span>h <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">loti_fc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">loti_train</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>            data <span class="op">=</span> <span class="fu">augment</span><span class="op">(</span><span class="va">loti_ets</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-nasa-ses-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Note">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Les prévisions climatiques sont effectuées par des modèles bien plus complexes que ce que nous voyons ici. Les prévisions du GIEC agrègent des tendances localisées et incluent une batterie de covariables, dont la plus évidente est la concentration en <span class="math inline">\(CO_2\)</span> dans l’atmosphère. Il s’agit seulement d’un exemple d’application.</p>
</div>
</div>
</section><section id="ses-avec-tendance" class="level4" data-number="12.3.2.2"><h4 data-number="12.3.2.2" class="anchored" data-anchor-id="ses-avec-tendance">
<span class="header-section-number">12.3.2.2</span> SES avec tendance</h4>
<p>La prévision précédente a peu d’intérêt, étant donnée qu’elle n’inclut pas de tendance. Or, nous pouvons en ajouter une à l’équation. Ainsi exprimée, la tendance changera aussi au fil du temps.</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead><tr class="header">
<th>Description</th>
<th>Équation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Prévision</td>
<td><span class="math inline">\(\hat{y}_{t + h|t} = l_t + \left( \phi + \phi^2 + ... + \phi^h \right) \times b_t\)</span></td>
</tr>
<tr class="even">
<td>Niveau</td>
<td><span class="math inline">\(l_t = \alpha y_t + \alpha\left( 1-\alpha \right) \left( l_{t-1} + \phi b_{t-1} \right)\)</span></td>
</tr>
<tr class="odd">
<td>Tendance</td>
<td><span class="math inline">\(b_t = \beta^* \left( l_t - l_{t-1} \right) + (1-\beta^*) \phi b_{t-1}\)</span></td>
</tr>
</tbody>
</table>
<p>Le paramètre <span class="math inline">\(\beta^*\)</span> décrit la vitesse à laquelle la tendance peut changer, de 0 où la pente ne change pas à 1 où la pente change rapidement. Le paramètre <span class="math inline">\(\phi\)</span> adoucit la pente en s’éloignant de la dernière mesure. Un <span class="math inline">\(\phi\)</span> tendant vers 0 générera un fort adoucissement, alors qu’un <span class="math inline">\(\phi\)</span> tendant vers 1 ne générera pas d’adoucissement. Il peut être difficile de déterminer les paramètres de lissage <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta^*\)</span> et <span class="math inline">\(\phi\)</span>, ainsi que les paramètres d’état <span class="math inline">\(l_0\)</span> et <span class="math inline">\(b_0\)</span>. La fonction de <code><a href="https://fable.tidyverts.org/reference/ETS.html">fable::ETS()</a></code> permet de les estimer automatiquement en sélectionnant le paramètre de tendance “A” et “Ad” respectivement pour la méthode Holt et Holt adoucit.</p>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">loti_holt</span> <span class="op">&lt;-</span> <span class="va">loti_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">model</span><span class="op">(</span></span>
<span>    `Holt's method` <span class="op">=</span> <span class="fu">ETS</span><span class="op">(</span><span class="va">LOTI</span> <span class="op">~</span> <span class="fu">error</span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                            <span class="fu">trend</span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">season</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    `Damped Holt's method` <span class="op">=</span> <span class="fu">ETS</span><span class="op">(</span><span class="va">LOTI</span> <span class="op">~</span> <span class="fu">error</span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                                   <span class="fu">trend</span><span class="op">(</span><span class="st">"Ad"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">season</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">loti_holt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">forecast</span><span class="op">(</span>h <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">loti_train</span>, level <span class="op">=</span> <span class="fl">80</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-nasa-holt-fit-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">loti_holt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  .model               term   estimate
  &lt;chr&gt;                &lt;chr&gt;     &lt;dbl&gt;
1 Holt's method        alpha  0.405   
2 Holt's method        beta   0.000100
3 Holt's method        l[0]  -0.217   
4 Holt's method        b[0]   0.00525 
5 Damped Holt's method alpha  0.484   
6 Damped Holt's method beta   0.000100
7 Damped Holt's method phi    0.829   
8 Damped Holt's method l[0]  -0.110   
9 Damped Holt's method b[0]  -0.0333  </code></pre>
</div>
</div>
<p>Dans ce cas, l’optimisation de <span class="math inline">\(\phi\)</span> lui donne une valeur de 0.8, une valeur suffisamment faible pour que l’adoucissement soit fort. Vous obtiendrez une valeur de <span class="math inline">\(\phi\)</span> plus élevée en ne considérant que les données obtenues depuis 1950 (en retirant le symbole “#” avant <code>loti_ts &lt;- loti_ts |&gt; filter(Year &gt;= 1950)</code>, plus haut).</p>
</section><section id="ses-avec-fluctuation-saisonnière" class="level4" data-number="12.3.2.3"><h4 data-number="12.3.2.3" class="anchored" data-anchor-id="ses-avec-fluctuation-saisonnière">
<span class="header-section-number">12.3.2.3</span> SES avec fluctuation saisonnière</h4>
<p>D’autres paramètres peuvent être ajoutés pour tenir compte des fluctuations saisonnières (les fluctuations cycliques sont plus difficiles à modéliser) de manière additive ou multiplicative. Voici la modification apportée pour la modélisation additive, en laissant tomber l’adoucissement.</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead><tr class="header">
<th>Description</th>
<th>Équation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Prévision</td>
<td><span class="math inline">\(\hat{y}_{t + h|t} = l_t + h \times b_t + s_{t-m+h_m^+}\)</span></td>
</tr>
<tr class="even">
<td>Niveau</td>
<td><span class="math inline">\(l_t = \alpha \left(y_t - s_{t-m} \right) + \alpha\left( 1-\alpha \right) \left( l_{t-1} + b_{t-1} \right)\)</span></td>
</tr>
<tr class="odd">
<td>Tendance</td>
<td><span class="math inline">\(b_t = \beta^* \left( l_t - l_{t-1} \right) + (1-\beta^*) b_{t-1}\)</span></td>
</tr>
<tr class="even">
<td>Saison</td>
<td><span class="math inline">\(s_t = \gamma \left( y_t - l_{t-1} - b_{t-1} \right) + (1-\gamma) s_{t-m}\)</span></td>
</tr>
</tbody>
</table>
<p>où <span class="math inline">\(m\)</span> est la périodicité des fluctuations saisonnières, par exemple 4 pour quatre saisons annuelles, et <span class="math inline">\(\gamma\)</span> est un paramètre de la portion saisonnière qui, tout comme un effet aléatoire en biostatistiques, fluctue autour de zéro. La variante multiplicative multiplie la prévision par un facteur plutôt que d’imposer un décalage. La mathématique n’est pas présentée ici pour plus de simplicité (consulter <a href="https://otexts.com/fpp3/holt-winters.html">Hyndman et Athanasopoulos (2021), chapitre 8.3</a> pour plus de détails). Dans le cas multiplicatif, l’effet saisonnier fluctue autour de 1. Si l’amplitude de la fluctuation s’accroît au fil de la série temporelle, la méthode multiplicative donnera probablement de meilleurs résultats.</p>
<p>La fonction que nous utiliserons pour les SES-saisonniers demeure <code><a href="https://fable.tidyverts.org/reference/ETS.html">fable::ETS()</a></code>, mais cette fois en ajoutant les paramètres saisonniers (et d’erreur) additifs (A) ou multiplicatifs (M). Les données de la NASA ne sont pas saisonnières (<code>frequency(loti_ts)</code> donne 1), donc nous utiliserons les données hydrométéorologiques présentées plus tôt.</p>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">frequency</a></span><span class="op">(</span><span class="va">loti_ts</span><span class="op">$</span><span class="va">LOTI</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">loti_hw</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">model</span><span class="op">(</span></span>
<span>    additif <span class="op">=</span> <span class="fu">ETS</span><span class="op">(</span><span class="va">`Débit`</span> <span class="op">~</span> <span class="fu">error</span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                            <span class="fu">trend</span><span class="op">(</span><span class="st">"Ad"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">season</span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    multiplicatif <span class="op">=</span> <span class="fu">ETS</span><span class="op">(</span><span class="va">`Débit`</span> <span class="op">~</span> <span class="fu">error</span><span class="op">(</span><span class="st">"M"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                                   <span class="fu">trend</span><span class="op">(</span><span class="st">"Ad"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">season</span><span class="op">(</span><span class="st">"M"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">loti_hw</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">additif</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">forecast</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-hw-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="automatiser-la-prévision-avec-les-ses" class="level4" data-number="12.3.2.4"><h4 data-number="12.3.2.4" class="anchored" data-anchor-id="automatiser-la-prévision-avec-les-ses">
<span class="header-section-number">12.3.2.4</span> Automatiser la prévision avec les SES</h4>
<p>L’erreur du modèle peut aussi être calculée de sorte qu’elle soit constante ou augmente selon le niveau (ou décalage). Nous avons donc plusieurs types de modèles de la famille SES.</p>
<ul>
<li>Tendance: [sans tendance, tendance additive, tendance adoucie]</li>
<li>Saison: [sans saison, saison additive, saison multiplicative]</li>
<li>Erreur: [erreur additive, erreur multiplicative]</li>
</ul>
<p>Lequel choisir? Encore une fois, on peut laisser R optimiser notre choix avec le modèle ETS par défaut (<em>error, tend and seasonnal</em>). L’optimisation est lancée avec la fonction <code><a href="https://fable.tidyverts.org/reference/ETS.html">fable::ETS()</a></code>, sans utiliser les paramètres.</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">ETS</span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">report</span><span class="op">(</span><span class="va">flow_model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: Débit 
Model: ETS(M,N,M) 
  Smoothing parameters:
    alpha = 0.01039885 
    gamma = 0.0001130398 

  Initial states:
    l[0]      s[0]     s[-1]     s[-2]     s[-3]     s[-4]     s[-5]     s[-6]
 127.508 0.6510795 0.9398916 0.7981482 0.4271636 0.6252629 0.8872449 0.6594389
    s[-7]    s[-8]    s[-9]    s[-10]    s[-11]
 1.274093 3.731665 1.521115 0.1877663 0.2971309

  sigma^2:  0.3679

     AIC     AICc      BIC 
1222.469 1228.469 1260.935 </code></pre>
</div>
</div>
<p>Le modèle retenu est un <code>ETS(M,N,M)</code>, définissant dans l’ordre le type d’erreur, de tendance et de saison selon <code>A</code> pour additif, <code>M</code> pour multiplicatif et <code>N</code> pour l’absence. Nous avons une erreur de type <code>M</code> (multiplicative), une tendance de type <code>N</code> (sans tendance) et une saison de type <code>M</code> (multiplicative). L’absence de valeur pour <code>phi</code> indique que l’adoucissement n’est probablement pas nécessaire.</p>
<p>Nous pouvons visualiser l’évolution des différentes composantes.</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">components</span><span class="op">(</span><span class="va">flow_model</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-ets-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Dans un modèle sans tendance, avec saisonnalité multiplicative, les données <em>levels</em> sont multipliées par les données <em>season</em> pour obtenir la prévision. Malgré l’absence de tendance dans le modèle, il semble que le débit a diminué de 2000 à 2003 entre deux états stables de 1998 à 2000 et de 2003 à 2006. Les données <em>remainder</em> représentent la résultante, les variations qui ne sont pas expliquées par le modèle.</p>
<p>La fonction <code><a href="https://fable.tidyverts.org/reference/ETS.html">fable::ETS()</a></code> génère un modèle, mais pas de prédiction. Pour obtenir une prédiction, nous devons utiliser la fonction <code><a href="https://generics.r-lib.org/reference/forecast.html">fabletools::forecast()</a></code>, comme on l’a vu dans les exemples précédents.</p>
<div class="cell">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_fc</span> <span class="op">&lt;-</span> <span class="va">flow_model</span> <span class="op">|&gt;</span> <span class="fu">forecast</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">flow_fc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-ets-pred-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>L’analyse d’exactitude et celle des résidus sont tout aussi pertinentes. La première est effectuée sur la prévision, et la seconde sur le modèle.</p>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">accuracy</span><span class="op">(</span><span class="va">flow_fc</span>, <span class="va">hydrometeo_monthly</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  .model     .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE  ACF1
  &lt;chr&gt;      &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 ETS(Débit) Test   3.77  70.0  55.6 -24.7  62.9  1.02 0.872 0.245</code></pre>
</div>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">gg_tsresiduals</span><span class="op">(</span><span class="va">flow_model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-ets-accuracy-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Il est peu probable que les résidus aient été générés par un bruit blanc, indiquant qu’il existe une structure dans les données qui n’a pas été capturée par le modèle.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercice">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Modéliser la série temporelle <code>lynx</code> avec <code><a href="https://fable.tidyverts.org/reference/ETS.html">fable::ETS()</a></code>. Que se passe-t-il?</p>
</div>
</div>
</section><section id="prétraitement-des-données" class="level4" data-number="12.3.2.5"><h4 data-number="12.3.2.5" class="anchored" data-anchor-id="prétraitement-des-données">
<span class="header-section-number">12.3.2.5</span> Prétraitement des données</h4>
<p>J’ai spécifié plus haut que les données de débit pourraient avantageusement être transformées avec un logarithme pour éviter les prédictions de débits négatifs. D’autres types de transformation peuvent être utilisées, comme la racine carrée ou cubique, l’opposée de l’inverse (<span class="math inline">\(-1/x\)</span>) ou les transformations compositionnelles (<a href="08-explorer.html" class="quarto-xref">chapitre&nbsp;<span>9</span></a>). La transformation Box-Cox est aussi largement utilisée pour sa polyvalence.</p>
<p><span class="math display">\[
w =
\begin{cases}
ln(y_t) &amp;\text{if } \lambda = 0 \\
\frac{y_t - 1}{\lambda} &amp;\text{if } \lambda \neq 0
\end{cases}
\]</span></p>
<p><span class="math inline">\(\lambda = 1\)</span> : pas de transformation</p>
<p><span class="math inline">\(\lambda = 1/2\)</span> : ressemble à <span class="math inline">\(\sqrt{y_t}\)</span></p>
<p><span class="math inline">\(\lambda = 1/3\)</span> : ressemble à <span class="math inline">\(\sqrt[3]{y_t}\)</span></p>
<p><span class="math inline">\(\lambda = 0\)</span> : log naturel</p>
<p><span class="math inline">\(\lambda = -1\)</span> : ressemble à <span class="math inline">\(1/y_t\)</span></p>
<p>La fonction <code><a href="https://fabletools.tidyverts.org/reference/features.html">fabletools::features()</a></code> estime la valeur optimale de <span class="math inline">\(\lambda\)</span> à partir de la méthode <code>guerrero</code> (<a href="https://doi.org/10.1002/for.3980120104">Guerrero, 1993</a>)</p>
<div class="cell">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">features</span><span class="op">(</span><span class="va">`Débit`</span>, features <span class="op">=</span> <span class="va">guerrero</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">lambda_guerrero</span><span class="op">)</span></span>
<span><span class="va">lambda</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7840971</code></pre>
</div>
</div>
<p>Cette valeur peut être imputée à l’argument <code>lambda</code> de la fonction <code><a href="https://fabletools.tidyverts.org/reference/box_cox.html">fabletools::box_cox()</a></code>, qu’on peut appliquer directement sur les données dans le modèle. Dans notre cas, nous désirions plutôt une transformation logarithmique. Conséquemment, nous utilisons <code>lambda = 0</code> (on aurait aussi pu simplement utiliser la fonction <code>log</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">noBox</span> <span class="op">&lt;-</span> <span class="va">flow_fc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flow_log_fc</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">ETS</span><span class="op">(</span><span class="fu">box_cox</span><span class="op">(</span><span class="va">`Débit`</span>, lambda <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">forecast</span><span class="op">(</span>h <span class="op">=</span> <span class="fl">24</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>.median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Box</span> <span class="op">&lt;-</span> <span class="va">flow_log_fc</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span></span>
<span>  <span class="va">noBox</span>,</span>
<span>  <span class="va">Box</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-boxcox-ets-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Les erreurs ne franchissent pas le 0, mais sont vraisemblablement surestimées aux sommets. Notez que R s’occupe de la transformation retour.</p>
<p>La <strong>différenciation</strong> est aussi une forme de prétraitement. La différenciation (fonction <code><a href="https://tsibble.tidyverts.org/reference/difference.html">tsibble::difference()</a></code>) consiste en la soustraction de la valeur précédente à la valeur suivante. La valeur précédente peut être décalée à la valeur de la période de l’unité temporelle précédente, par exemple le mois de mars de l’année précédente. Un objectif de la différenciation est de rendre la série temporelle stationnaire en termes de tendance et de fluctuation saisonnière, de sorte que la série différenciée se comporte comme un bruit blanc.</p>
<div class="cell">
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span></span>
<span>  <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Débit"</span><span class="op">)</span>,</span>
<span>  <span class="va">loti_train</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"LOTI"</span><span class="op">)</span>,</span>
<span>  <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff_debit <span class="op">=</span> <span class="fu">difference</span><span class="op">(</span><span class="va">`Débit`</span>, lag <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">diff_debit</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Débit avec différenciation saisonnière"</span><span class="op">)</span>,</span>
<span>  <span class="va">loti_train</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff_LOTI <span class="op">=</span> <span class="fu">difference</span><span class="op">(</span><span class="va">LOTI</span>, lag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">diff_LOTI</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"LOTI avec différenciation d'ordre 1"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-preprocess-grid-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="la-méthode-arima" class="level3" data-number="12.3.3"><h3 data-number="12.3.3" class="anchored" data-anchor-id="la-méthode-arima">
<span class="header-section-number">12.3.3</span> La méthode ARIMA</h3>
<p>Un modèle ARIMA, acronyme de l’anglais <em>auto-regressive integrated moving average</em>, est une combinaison de trois parties: AR-I-MA. L’<strong>autorégression</strong> est une régression linéaire dont la variable réponse <span class="math inline">\(y_t\)</span> est la variable à l’instant <span class="math inline">\(t\)</span> et les variables explicatives sont les variables aux instants précédents. Pour un nombre <span class="math inline">\(p\)</span> de périodes précédentes, nous obtenons une régression linéaire typique.</p>
<p><span class="math display">\[y_t = c + \phi_1 y_{t-1} + \phi_2 y_{t-2} + ... + \phi_p y_{t-p} + \epsilon_t\]</span> où <span class="math inline">\(\epsilon_t\)</span> est l’erreur sur la prédiction.</p>
<p>La partie concernant la <strong>moyenne mobile</strong> est une régression non pas sur les observations, mais sur les erreurs. Considérant les <span class="math inline">\(q\)</span> erreurs précédentes, nous obtenons</p>
<p><span class="math display">\[y_t = c + \theta_1 \epsilon_{t-1} + \theta_2 \epsilon_{t-2} + ... + \theta_q \epsilon_{t-q} + \epsilon_t\]</span></p>
<p>La somme de l’autorégression et de la moyenne mobile donne un modèle ARMA. Le I de ARIMA, mis pour <em>integrated</em>, est le contraire de la différenciation, que j’ai présenté à la fin de la section sur les SES. Puisque la série temporelle doit être stationnaire pour effectuer l’ARMA, nous devons différencier la série un nombre <span class="math inline">\(d\)</span> de fois avant de procéder à l’autorégression et au calcul de la moyenne mobile.</p>
<p>Nous obtenons ainsi une ARIMA d’ordres <span class="math inline">\(p\)</span>, <span class="math inline">\(d\)</span> et <span class="math inline">\(q\)</span>, notée <span class="math inline">\(ARIMA(p,d,q)\)</span>. Nous devons aussi statuer si <span class="math inline">\(c\)</span> (l’intercept ou le <em>drift</em>) doit être ou non considéré come nul. Ces ordres peuvent être spécifiés dans la fonction telle que <code>fable::ARIMA(x ~ pdq(0, 1, 1))</code>. Toutefois, il est possible de les optimiser grâce à la fonction <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">fable::ARIMA()</a></code>. Tout comme les sorties de <code><a href="https://fable.tidyverts.org/reference/ETS.html">fable::ETS()</a></code>, <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">fable::ARIMA()</a></code> fournit le modèle, mais pas les prédictions : la fonction <code><a href="https://generics.r-lib.org/reference/forecast.html">fabletools::forecast()</a></code> doit être lancée pour obteir la prédiction.</p>
<div class="cell">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">loti_arima</span> <span class="op">&lt;-</span> <span class="va">loti_train</span> <span class="op">|&gt;</span> <span class="fu">model</span><span class="op">(</span><span class="fu">ARIMA</span><span class="op">(</span><span class="va">LOTI</span>, stepwise <span class="op">=</span> <span class="cn">FALSE</span>, approximation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">loti_arima</span> <span class="op">|&gt;</span> <span class="fu">forecast</span><span class="op">(</span>h <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">loti_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-nasa-arima-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">report</span><span class="op">(</span><span class="va">loti_arima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: LOTI 
Model: ARIMA(1,1,3) w/ drift 

Coefficients:
          ar1     ma1      ma2      ma3  constant
      -0.9405  0.6260  -0.6019  -0.3716    0.0116
s.e.   0.0522  0.0976   0.0847   0.0846    0.0060

sigma^2 estimated as 0.01036:  log likelihood=109.53
AIC=-207.06   AICc=-206.35   BIC=-190.14</code></pre>
</div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">accuracy</span><span class="op">(</span><span class="va">loti_arima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  .model            .type       ME   RMSE    MAE   MPE  MAPE  MASE RMSSE    ACF1
  &lt;chr&gt;             &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 ARIMA(LOTI, step… Trai… -7.95e-4 0.0993 0.0824  22.6  65.4 0.893 0.875 -0.0221</code></pre>
</div>
</div>
<p>Le sommaire du modèle spécifie une <span class="math inline">\(ARIMA(1,1,3)\)</span> en utilisant l’intercept <span class="math inline">\(c\)</span> (<em>with drift</em>).</p>
<p>Lorsque l’on compte prédire des séries saisonnières, nous devons ajouter un nouveau jeu d’ordres <span class="math inline">\((P,D,Q)m\)</span>, où <span class="math inline">\(P\)</span>, <span class="math inline">\(D\)</span> et <span class="math inline">\(Q\)</span> sont équivalents à leurs minuscules, mais portent sur des décalages saisonniers et non pas des décalages d’unités de temps. L’ordre <span class="math inline">\(m\)</span> est le nombre de périodes à considérer par unité temporelle, par exemple 12 mois par an. Bonne nouvelle: <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">fable::ARIMA()</a></code> automatise le tout si vous spécifiez <code>stepwise = FALSE</code> et <code>approximation = FALSE</code>, bien qu’il travaille très fort pour le faire. Par contre, lorsque vous connaissez l’existence d’une saisonnalité, il est parfois préférable de spécifier directement vos paramètres avec les fonctions <code>pdq</code> et <code>PDQ</code>. Nous pouvons aussi utiliser <code>log</code> pour effectuer une transformation logarithmique.</p>
<div class="cell">
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_arima</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span>, stepwise <span class="op">=</span> <span class="cn">FALSE</span>, approximation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">flow_arima</span> <span class="op">|&gt;</span> <span class="fu">forecast</span><span class="op">(</span>h <span class="op">=</span> <span class="fl">36</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-arima-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">report</span><span class="op">(</span><span class="va">flow_arima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: Débit 
Model: ARIMA(1,0,0)(0,1,1)[12] 
Transformation: log(Débit) 

Coefficients:
         ar1     sma1
      0.3169  -0.8581
s.e.  0.1028   0.2629

sigma^2 estimated as 0.5217:  log likelihood=-98.36
AIC=202.72   AICc=203.02   BIC=210.01</code></pre>
</div>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">glance</span><span class="op">(</span><span class="va">flow_arima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  .model                      sigma2 log_lik   AIC  AICc   BIC ar_roots ma_roots
  &lt;chr&gt;                        &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;   &lt;list&gt;  
1 ARIMA(log(Débit), stepwise…  0.522   -98.4  203.  203.  210. &lt;cpl&gt;    &lt;cpl&gt;   </code></pre>
</div>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">accuracy</span><span class="op">(</span><span class="va">flow_arima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  .model                  .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE   ACF1
  &lt;chr&gt;                   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 ARIMA(log(Débit), step… Trai…  10.6  64.6  36.2 -33.3  60.0 0.664 0.805 -0.162</code></pre>
</div>
</div>
<p>Le sommaire du modèle, <code>ARIMA(1,0,0)(0,1,1)[12]</code> sous le format <span class="math inline">\(ARIMA(p,d,q)(P,D,Q)m\)</span>, retourne automatiquement une période de 12 mois avec un pic aux 12 mois sans différenciation saisonnière et sans différenciation ordinaire, excluant la moyenne mobile dans les deux cas.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Exercice">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercice
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est toujours pertinent d’effectuer l’analyse des résidus…</p>
</div>
</div>
</section><section id="les-modèles-dynamiques" class="level3" data-number="12.3.4"><h3 data-number="12.3.4" class="anchored" data-anchor-id="les-modèles-dynamiques">
<span class="header-section-number">12.3.4</span> Les modèles dynamiques</h3>
<p>J’ai noté précédemment que l’évolution du climat tient compte d’une série de covariables explicatives. De même, le débit dans la rivière Chaudière n’est pas un effet de la saison, mais de son environnement (climat, changements dans la morphologie du paysage, utilisation de l’eau, etc.). La prévision du débit aura avantage à considérer ces covariables. L’ARIMA peut accueillir des covariables en modélisant le terme d’erreur, <span class="math inline">\(\epsilon_t\)</span> en fonction de séries temporelles conjointes.</p>
<p>Le débit mensuel de la rivière Chaudière peut être modélisé en fonction de la température moyenne mensuelle et des précipitations totales mensuelles en ajoutant les covariables à l’intérieur de la fonction <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">fable::ARIMA</a></code>, un peu comme on l’avait pour les régressions linéaires par exemple. Regardons tout d’abord les séries temporelles d’entraînement</p>
<div class="cell">
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_ts_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">date_month</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_month</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">name</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-arima-dyn-ts-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_darima</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">ARIMA</span><span class="op">(</span><span class="fu">box_cox</span><span class="op">(</span><span class="va">`Débit`</span>, lambda <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">~</span> <span class="va">total_precip</span> <span class="op">+</span> <span class="va">mean_temp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">report</span><span class="op">(</span><span class="va">flow_darima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: Débit 
Model: LM w/ ARIMA(0,0,1)(2,1,0)[12] errors 
Transformation: box_cox(Débit, lambda = 0) 

Coefficients:
         ma1     sar1     sar2  total_precip  mean_temp
      0.2787  -0.4424  -0.2561        0.0027     0.0104
s.e.  0.1068   0.1279   0.1195        0.0016     0.0475

sigma^2 estimated as 0.6605:  log likelihood=-100.84
AIC=213.68   AICc=214.77   BIC=228.27</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Note">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour obtenir des résultats plus précis, mais dont les résultats seront plus longs à venir, spécifiez l’argument <code>stepwise = FALSE</code> et <code>approximation = FALSE</code> dans la fonction <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">fable::ARIMA()</a></code>.</p>
</div>
</div>
<p>Les coefficients sur les covariables sont interprétables <em>dans l’échelle de la prévision transformée</em>. Ainsi, 1 mm de précipitation par mois augmentera le logarithme naturel du débit de 0.0027. De même, 1 °C de température moyenne augmentera le logarithme naturel du débit de 0.0104: notez que l’erreur standard sur ce coefficient étant très élevée, le coefficient n’est à première vue pas différent de 0. La température moyenne aurait avantage à être remplacée par un meilleur indicateur incluant les périodes d’accumulation de neige et de leur fonte. Pas mal doc?</p>
<p><img src="https://media.giphy.com/media/kk1zu1tVwuecM/giphy.gif" class="img-fluid"></p>
<p>Source: Scène de Back to the future, Robert Zemeckis et and Bob Gale, 1985</p>
<p>Et pour l’analyse de résidus…</p>
<div class="cell">
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_darima</span> <span class="op">|&gt;</span> <span class="fu">gg_tsresiduals</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-arima-dyn-res-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Les résidus du modèle ARIMA(0,0,1)(2,1,0)[12] présentent un pic significatif à 13 mois, mais pour le reste ils se comportent assez comme un bruit blanc. Pour s’en assurer, on utilise un test Ljung-Box. Pour déterminer le nombre de degrés de liberté, on s’assure d’utiliser la somme du nombre de paramètres AR et MA dans le modèle, soit les paramètres (p,q)(P,Q), en laissant de côté les paramètres du milieu (d et D). Dans notre cas, on a seulement 3 degrés de liberté.</p>
<div class="cell">
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">augment</span><span class="op">(</span><span class="va">flow_darima</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">features</span><span class="op">(</span><span class="va">.innov</span>, <span class="va">ljung_box</span>, dof <span class="op">=</span> <span class="fl">3</span>, lag <span class="op">=</span> <span class="fl">24</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .model                                                       lb_stat lb_pvalue
  &lt;chr&gt;                                                          &lt;dbl&gt;     &lt;dbl&gt;
1 ARIMA(box_cox(Débit, lambda = 0) ~ total_precip + mean_temp)    31.9    0.0598</code></pre>
</div>
</div>
<p>Une p-value de 0.059 est un peu faible mais passe tout juste le test de Ljung-Box, si bien qu’il est fort probable que les résidus soient issus d’un bruit blanc. Le modèle peut donc être utilisé pour effectuer une prévision.</p>
<p>La prévision d’un modèle dynamique demandera les séries temporelles des covariables, qui peuvent elles-mêmes être modélisées ou être issues de simulations. Si on avait accès aux prévisions météorologiques par exemple, on pourrait les utiliser pour alimenter notre modèle. Dans notre cas, utilisons simplement les moyennes mensuelles de précipitations et de températures des dernières années (on aurait aussi pû utiliser les données de test).</p>
<div class="cell">
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_average</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mois <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">date_month</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">mois</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>total_precip <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">total_precip</span><span class="op">)</span>,</span>
<span>            mean_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mean_temp</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">flow_future</span> <span class="op">&lt;-</span> <span class="fu">new_data</span><span class="op">(</span><span class="va">flow_ts_train</span>, <span class="fl">24</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>mois <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">date_month</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">flow_average</span>, by <span class="op">=</span> <span class="st">"mois"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">forecast</span><span class="op">(</span><span class="va">flow_darima</span>, <span class="va">flow_future</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-arima-dyn-fc-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Pour terminer, revenons à notre fonction d’autocorrélation présentée plus tôt. Lorsque vous êtes en présence de covariables, vous pouvez déterminer s’il existe une corrélation croisée entre deux séries univariées avec la fonction <code><a href="https://feasts.tidyverts.org/reference/ACF.html">feasts::CCF()</a></code>. Attention toutefois : Une corrélation significative n’indique pas nécessairement de cause à effet, et ne renseigne pas sur l’amplitude d’un effet. Si l’on reprend l’exemple de la covariable température, dont l’effet semblait quasi-nul, on obtient ceci.</p>
<div class="cell">
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">CCF</span><span class="op">(</span><span class="va">flow_ts_train</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">mean_temp</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-ccf-temp-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On remarque que les deux séries temporelles sont fortement corrélées sur un cycle de 12 mois, avec un décalage d’environ 3 mois. Cette corrélation nous informe que lorsque la température commence à augmenter au temps <span class="math inline">\(t\)</span>, le débit augmente au temps <span class="math inline">\(t_{+3}\)</span>, mais diminue au temps <span class="math inline">\(t_{-3}\)</span>. De la même façon, si la température diminue au temps <span class="math inline">\(t\)</span>, le débit diminue à <span class="math inline">\(t_{+3}\)</span> et augmente à <span class="math inline">\(t_{-3}\)</span>. Cela correspond aux crues printannières et automnales. Ainsi, la température et le débit évoluent selon des cycles similaires, ce qui nous amène aux modèles à saisonnalité plus complexes.</p>
</section><section id="les-modèles-à-saisonnalité-complexe" class="level3" data-number="12.3.5"><h3 data-number="12.3.5" class="anchored" data-anchor-id="les-modèles-à-saisonnalité-complexe">
<span class="header-section-number">12.3.5</span> Les modèles à saisonnalité complexe</h3>
<p>Les méthodes présentées jusqu’ici reposent sur une tendance simple ou une saisonnalité simple. Toutefois, dans le cas de données à plus haute fréquence, interrompues ou plus étendue, il arrive souvent qu’une superposition de cycle existe. Je n’irai pas trop en détails pour cette section parce que ça peut devenir complexe assez rapidement, mais vous pouvez consulter <a href="https://otexts.com/fpp3/complexseasonality.html">Hyndman et Athanasopoulos, 2021 chapitre 12.1</a>.</p>
<section id="régression-dynamique-harmonique" class="level4" data-number="12.3.5.1"><h4 data-number="12.3.5.1" class="anchored" data-anchor-id="régression-dynamique-harmonique">
<span class="header-section-number">12.3.5.1</span> Régression dynamique harmonique</h4>
<p>Lorsque les modèles présentent des cycles plus longs, les modèles de régression dynamiques avec transformées de Fourier sont souvent plus performants. Par exemple, une série temporelle peut être constituée à la fois d’un cycle annuel (365 jours), d’un cycle hebdomadaire (7 jours) et d’un cycle journalier (24 heures). Cette superposition de cycles peut être déterminée par le périodogramme et les transformées de Fourier.</p>
<p>Je ne rentrerai pas dans le détail des séries de Fourier, mais on peut l’utiliser avec la fonction… Roulement de tambours… <code><a href="https://fable.tidyverts.org/reference/ARIMA.html">fable::ARIMA()</a></code>. Dans ce cas, on spécifiera un paramètre de lissage <span class="math inline">\(K\)</span> plutôt que d’utiliser les paramètres de saisonnalité (P,D,Q). Un exemple, directement adapté de <a href="https://otexts.com/fpp3/dhr.html">Hyndman et Athanasopoulos, 2021 chapitre 10.5</a> :</p>
<div class="cell">
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_fourier</span> <span class="op">&lt;-</span> <span class="va">flow_ts_train</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">model</span><span class="op">(</span></span>
<span>    K1 <span class="op">=</span> <span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">~</span> <span class="fu">fourier</span><span class="op">(</span>K<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">PDQ</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    K2 <span class="op">=</span> <span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">~</span> <span class="fu">fourier</span><span class="op">(</span>K<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">PDQ</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    K3 <span class="op">=</span> <span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">~</span> <span class="fu">fourier</span><span class="op">(</span>K<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu">PDQ</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    K4 <span class="op">=</span> <span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">~</span> <span class="fu">fourier</span><span class="op">(</span>K<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu">PDQ</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    K5 <span class="op">=</span> <span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">~</span> <span class="fu">fourier</span><span class="op">(</span>K<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="op">+</span> <span class="fu">PDQ</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    K6 <span class="op">=</span> <span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">~</span> <span class="fu">fourier</span><span class="op">(</span>K<span class="op">=</span><span class="fl">6</span><span class="op">)</span> <span class="op">+</span> <span class="fu">PDQ</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">flow_fourier</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">forecast</span><span class="op">(</span>h <span class="op">=</span> <span class="st">"3 years"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span>, level <span class="op">=</span> <span class="fl">80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">.model</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"none"</span>, fill <span class="op">=</span> <span class="st">"none"</span>, level <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_label</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">yearmonth</span><span class="op">(</span><span class="st">"Jan 2000"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fl">750</span>,</span>
<span>        label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"AICc = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">AICc</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="fu">glance</span><span class="op">(</span><span class="va">flow_fourier</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-fourier-viz-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="autres-méthodes" class="level3" data-number="12.3.6"><h3 data-number="12.3.6" class="anchored" data-anchor-id="autres-méthodes">
<span class="header-section-number">12.3.6</span> Autres méthodes</h3>
<p>Il existe plusieurs autres méthodes, par exemple en utilisant les réseaux neuronnaux <a href="https://otexts.com/fpp3/nnetar.html">Hyndman et Athanasopoulos, 2021 chapitre 12.4</a> ou d’autres modèles comme le module <a href="https://pkg.mitchelloharawild.com/fable.prophet/"><strong><code>fable.prophet::prophet</code></strong></a>. Ce dernier, distribué par Facebook de façon <em>open-source</em>, gagne en popularité et a l’avantage d’être rapide, mais n’est pas nécessairement plus performant que les autres méthodes mentionnées précédemment. Voici une comparaison entre les prédictions des modèles ARIMA, ETS et prophet.</p>
<div class="cell">
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.mitchelloharawild.com/fable.prophet/">fable.prophet</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Le chargement a nécessité le package : Rcpp</code></pre>
</div>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flow_ts_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://fabletools.tidyverts.org/reference/model.html">model</a></span><span class="op">(</span></span>
<span>    arima <span class="op">=</span> <span class="fu">ARIMA</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ets <span class="op">=</span> <span class="fu">ETS</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    prophet <span class="op">=</span> <span class="fu"><a href="https://pkg.mitchelloharawild.com/fable.prophet/reference/prophet.html">prophet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">`Débit`</span><span class="op">)</span> <span class="op">~</span> <span class="fu">season</span><span class="op">(</span>period <span class="op">=</span> <span class="fl">12</span>, order <span class="op">=</span> <span class="fl">2</span>, type <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html">forecast</a></span><span class="op">(</span>h <span class="op">=</span> <span class="st">"2 years"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">flow_ts_train</span>, level <span class="op">=</span> <span class="fl">80</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">.model</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="11-series-temporelles_files/figure-html/ts-hm-prophet-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="pour-terminer" class="level2" data-number="12.4"><h2 data-number="12.4" class="anchored" data-anchor-id="pour-terminer">
<span class="header-section-number">12.4</span> Pour terminer…</h2>
<p>Nous avons vu comment manipuler des séries temporelles avec <strong><code>dplyr</code></strong>, <strong><code>feasts</code></strong> et le format <code>tsibble</code>, puis comment modéliser avec <strong><code>fable</code></strong>. Je suis passé rapidement sur la dernière section portant sur les modèles à saisonnalité complexe puisque ce sujet ferait l’objet d’un cours en soi, mais ce type de modèles peut devenir très puissant et intéressant pour la modélisation de certaines données environnementales, par exemple les données météorologiques. Les outils présentés permettent aussi d’intégrer des covariables au modèles avec transformées de Fourier, mais il est préférable de bien comprendre ce qu’on fait avant d’utiliser ce type de méthodes…</p>
<p>Et maintenant, le futur vous appartient.</p>
<p><img src="https://media.giphy.com/media/3o7aCRBQC8u5GaW092/giphy.gif" class="img-fluid"></p>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./10-imputation.html" class="pagination-link" aria-label="Détection de valeurs aberrantes et imputation de données manquantes">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Détection de valeurs aberrantes et imputation de données manquantes</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./12-autoapprentissage.html" class="pagination-link" aria-label="Introduction à l'autoapprentissage">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Introduction à l’autoapprentissage</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Analyse et modélisation d’agroécosystèmes est construit avec <a href="https://quarto.org/">Quarto</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Lien vers le <a href="https://essicolo.github.io/ecologie-mathematique-R/">manuel original</a>.</p>
</div>
  </div>
</footer>


</body></html>